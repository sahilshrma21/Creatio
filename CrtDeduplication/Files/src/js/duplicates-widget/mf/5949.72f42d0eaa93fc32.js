(self.webpackChunkapp_studio_enterprise_duplicates_widget=self.webpackChunkapp_studio_enterprise_duplicates_widget||[]).push([[5949],{67791:(A,C,u)=>{u.r(C),u.d(C,{BaseEntityService:()=>R,DataServiceQueryExecutor:()=>l,DataServiceQueryExecutorModule:()=>f,EsqServerCacheLevels:()=>x,InvalidQueryResponseException:()=>I,InvalidResponseException:()=>E,LegacyDataServiceQueryExecutor:()=>g,LegacyDataServiceQueryExecutorModule:()=>S,QueryExecutor:()=>c,QueryKind:()=>p,QuerySource:()=>Q,ServerESQCacheParameters:()=>D});var a=u(75378),d=u(21322),n=u(27049);class R{constructor(e,t,r){this.queryExecutor=e,this._translateService=t,this.entityConverter=r,this.absentDataErrorKey="BaseSection.AbsentDataErrorMessage",this.primaryColumnName="Id"}_convertToErrorInfo(e){return{errorCode:null,message:e.message,stackTrace:e.stack}}_addColumnsToEsq(e){this.entityConverter.getEntityColumns({}).forEach(r=>{e.addSchemaColumn(r.path)})}_createDeleteQuery(){return new a.DeleteQuery(this.entitySchemaName)}getBaseErrorResponse(e){return(0,d.of)({success:!1,errorInfo:this._convertToErrorInfo(e),result:null})}handleResponse(e){return e.pipe((0,n.map)(()=>({success:!0,errorInfo:null,result:[]})),(0,n.catchError)(t=>(0,d.of)({success:!1,errorInfo:this._convertToErrorInfo(t),result:[]})))}getItemByIdEsq(e){const t=new a.EntitySchemaQuery(this.entitySchemaName);return this._addColumnsToEsq(t),t.filters.addSchemaColumnFilterWithParameter(a.ComparisonType.Equal,this.primaryColumnName,e),t}createGetAllItemsEsq(){const e=new a.EntitySchemaQuery(this.entitySchemaName);return this._addColumnsToEsq(e),e}getUpdateQuery(e){const t=new a.UpdateQuery(this.entitySchemaName);return this.entityConverter.getEntityColumns(e).forEach(s=>{this.primaryColumnName===s.path?t.filters.addSchemaColumnFilterWithParameter(a.ComparisonType.Equal,this.primaryColumnName,s.value):t.addColumn(s.path,s.value,s.type)}),t}getInsertQuery(e){const t=new a.InsertQuery(this.entitySchemaName);return this.entityConverter.getEntityColumns(e).forEach(s=>{this.primaryColumnName===s.path&&!s.value||t.addColumn(s.path,s.value,s.type)}),t}getDeleteQuery(e){return this.getDeleteQueryWithPrimaryColumnFilter(e.id)}getDeleteQueryWithPrimaryColumnFilter(e){const t=this._createDeleteQuery();return t.filters.addSchemaColumnFilterWithParameter(a.ComparisonType.Equal,this.primaryColumnName,e),t}loadAdditionalInfo(e){return(0,d.of)(e)}getItems(){const e=this.createGetAllItemsEsq();return this.queryExecutor.executeSelectQuery(e).pipe((0,n.mergeMap)(t=>this.loadAdditionalInfo(t)),(0,n.map)(t=>({success:!0,errorInfo:null,result:t.map(r=>this.entityConverter.getEntity(r))})),(0,n.catchError)(t=>this.getBaseErrorResponse(t)))}getItem(e){const t=this.getItemByIdEsq(e);return this.queryExecutor.executeSelectQuery(t).pipe((0,n.tap)(r=>{if(!(r&&r[0])){const s=this._translateService.instant(this.absentDataErrorKey);throw new Error(s)}}),(0,n.mergeMap)(r=>this.loadAdditionalInfo(r)),(0,n.map)(r=>({success:!0,errorInfo:null,result:[this.entityConverter.getEntity(r[0])]})),(0,n.catchError)(r=>this.getBaseErrorResponse(r)))}insertItem(e){const t=this.getInsertQuery(e),r=this.queryExecutor.executeInsertQuery(t);return this.handleResponse(r)}updateItem(e){const t=this.getUpdateQuery(e),r=this.queryExecutor.executeUpdateQuery(t);return this.handleResponse(r)}deleteItem(e){const t=this.getDeleteQuery(e),r=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(r)}deleteById(e){const t=this.getDeleteQueryWithPrimaryColumnFilter(e),r=this.queryExecutor.executeDeleteQuery(t);return this.handleResponse(r)}}var w=u(8239),m=u(74742),v=u(2876),o=u(94450),y=u(49475);class c{}c.\u0275fac=function(e){return new(e||c)},c.\u0275prov=o.\u0275\u0275defineInjectable({token:c,factory:c.\u0275fac});var p;(function(i){i[i.General=0]="General",i[i.Limited=1]="Limited"})(p||(p={}));var Q;(function(i){i[i.Undefined=0]="Undefined",i[i.Filter=1]="Filter",i[i.FilterSummary=2]="FilterSummary"})(Q||(Q={}));var x;(function(i){i[i.Session=0]="Session",i[i.Workspace=1]="Workspace",i[i.Application=2]="Application"})(x||(x={}));class D{constructor(e=x.Session,t="",r=""){this._cacheLevel=e,this._cacheGroup=t,this._cacheItemName=r}getMetadata(){return{cacheLevel:this._cacheLevel,cacheGroup:this._cacheGroup,cacheItemName:this._cacheItemName}}}class I extends Error{constructor(e){super(`Query with config
${JSON.stringify(e.getMetadata())}
finished with error.`)}}class E extends Error{constructor(e){const t=e?.error?.responseStatus?.Message||e?.responseStatus?.Message||e?.message;super(t),this.errorCode=e?.error?.responseStatus?.ErrorCode}}let g=class extends c{constructor(e,t,r){super(),this._sysSettingsService=e,this._httpClient=t,this._dataServiceUri=r,this._defaultDebounceTime=200,this._debounceTimeSysSettingName="QueryExecutorDebounceTime",this._requests=new d.Subject,a.ValidationUtilities.checkArgumentEmpty("_httpClient",t),a.ValidationUtilities.checkArgumentEmpty("_dataServiceUri",r)}_executeWritableQuery(e,t){const s={...e.getMetadata(),queryKind:p.General};return this._httpClient.post(t,s).pipe((0,n.catchError)(h=>{throw new E(h)}),(0,n.tap)(h=>{if(!(h&&h.success))throw new I(e)}))}_getQueryUri(e){if(e instanceof a.SelectLocalizationQuery)return`${this._dataServiceUri}/SelectLocalizationQuery`;if(e instanceof a.EntitySchemaQuery)return`${this._dataServiceUri}/SelectQuery`;if(e instanceof a.InsertQuery)return`${this._dataServiceUri}/InsertQuery`;if(e instanceof a.UpdateQuery)return`${this._dataServiceUri}/UpdateQuery`;if(e instanceof a.DeleteQuery)return`${this._dataServiceUri}/DeleteQuery`;throw new Error("Unsupported query type")}_getBundleSettings(){var e=this;return(0,w.Z)(function*(){return e._sysSettingsService?{executionDebounceTime:(yield e._sysSettingsService.getByCodes([e._debounceTimeSysSettingName])).values[e._debounceTimeSysSettingName]?.value||e._defaultDebounceTime}:Promise.resolve({executionDebounceTime:e._defaultDebounceTime})})()}_prepareDebouncedResponsesStream(){if(this._responses)return;let e=0;const t=(0,n.buffer)(this._requests.pipe((0,n.switchMap)(()=>(0,d.from)(this._getBundleSettings())),(0,n.tap)(r=>e=r.executionDebounceTime),(0,n.debounceTime)(e)));this._responses=this._requests.pipe(t,(0,n.filter)(r=>!!r.length),(0,n.mergeMap)(r=>{const s=r.map(_=>_.id),h=r.map(_=>_.query);return this.executeBatchSelectQuery(h).pipe((0,n.map)(_=>s.reduce((U,q,M)=>U.set(q,_[M]),new Map)))}),(0,n.share)())}_executeThrottled(e){this._prepareDebouncedResponsesStream();const t={id:(0,a.generateGuid)(),query:e},r=this._responses.pipe((0,n.filter)(s=>s.has(t.id)),(0,n.map)(s=>s.get(t.id)),(0,n.take)(1));return r.subscribe(),this._requests.next(t),r}_executeImmediate(e){a.ValidationUtilities.checkArgumentEmpty("query",e);const t=this._getQueryUri(e),r=this._getQueryRequest(e);return this._httpClient.post(t,r).pipe((0,n.catchError)(s=>{throw new E(s)}),(0,n.tap)(s=>{if(!s?.rows)throw new I(e)}),(0,n.map)(s=>this._toSelectQueryResponse(s)))}_toSelectQueryResponse(e){const t=this.getRowsFromResponse(e);return t.rowsAffected=e.rowsAffected,e.errorInfo&&(t.errorInfo=e.errorInfo),t}_getQueryRequest(e){const t=e.getMetadata();return e instanceof a.EntitySchemaQuery?{...t,queryKind:p.General,serverESQCacheParameters:new D().getMetadata(),queryOptimize:!1,useMetrics:!1,querySource:Q.Undefined}:{...t,queryKind:p.General}}getRowsFromResponse(e){return e.rows}executeSelectQuery(e,t={throttled:!1}){return t.throttled?this._executeThrottled(e):this._executeImmediate(e)}executeInsertQuery(e){return this.execute(e)}executeUpdateQuery(e){return this.execute(e)}executeDeleteQuery(e){return this.execute(e)}execute(e){a.ValidationUtilities.checkArgumentEmpty("query",e);const t=this._getQueryUri(e);return this._executeWritableQuery(e,t)}executeBatchSelectQuery(e){if(a.ValidationUtilities.checkArgumentEmpty("queries",e),e.length===0)return(0,d.of)([]);const t=`${this._dataServiceUri}/BatchQuery`,r={items:[]};return r.items=e.map(s=>({...this._getQueryRequest(s),__type:"Terrasoft.Nui.ServiceModel.DataContract.SelectQuery"})),this._httpClient.post(t,r).pipe((0,n.catchError)(s=>{throw new E(s)}),(0,n.tap)(s=>{if(!s||s.hasErrors)throw new E(s)}),(0,n.map)(s=>s.queryResults.map(h=>this._toSelectQueryResponse(h))))}};g=(0,m.__decorate)([(0,m.__param)(0,(0,o.Optional)()),(0,m.__param)(2,(0,o.Inject)(y.DATA_SERVICE_URI)),(0,m.__metadata)("design:paramtypes",[a.SysSettingsService,v.HttpClient,String])],g);var T=u(33177);let l=class extends g{constructor(e,t,r,s){super(e,t,s),this._entityDeserializer=r}getRowsFromResponse(e){return this._entityDeserializer.deserializeEntities(e.rowConfig,e.rows)}};l.\u0275fac=function(e){return new(e||l)(o.\u0275\u0275inject(a.SysSettingsService,8),o.\u0275\u0275inject(v.HttpClient),o.\u0275\u0275inject(y.EntityDeserializer),o.\u0275\u0275inject(y.DATA_SERVICE_URI))},l.\u0275prov=o.\u0275\u0275defineInjectable({token:l,factory:l.\u0275fac}),l=(0,m.__decorate)([(0,T.CrtHandlerChainAdapter)({requestType:"crt.DataServiceQueryExecutor"}),(0,m.__metadata)("design:paramtypes",[a.SysSettingsService,v.HttpClient,y.EntityDeserializer,String])],l);class f{}f.\u0275fac=function(e){return new(e||f)},f.\u0275mod=o.\u0275\u0275defineNgModule({type:f}),f.\u0275inj=o.\u0275\u0275defineInjector({providers:[y.DATA_SERVICE_URI_PROVIDER,{provide:c,useClass:l}]});class S{}S.\u0275fac=function(e){return new(e||S)},S.\u0275mod=o.\u0275\u0275defineNgModule({type:S}),S.\u0275inj=o.\u0275\u0275defineInjector({providers:[y.DATA_SERVICE_URI_PROVIDER,{provide:c,useFactory:(i,e,t)=>new g(i,e,t),deps:[[new o.Optional,a.SysSettingsService],v.HttpClient,y.DATA_SERVICE_URI]}]})}}]);
