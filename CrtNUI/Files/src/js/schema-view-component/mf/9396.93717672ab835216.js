(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[9396],{69396:(Ue,ne,f)=>{f.r(ne),f.d(ne,{AttributeConfigProvider:()=>V,AttributeControlDataValueTypeDesignConfig:()=>y,AttributeControlExtraConfigProvider:()=>W,BaseDesignerCommand:()=>Ae,ColumnControlDataValueTypeDesignConfig:()=>se,ConnectedDropListService:()=>L,ControlTypes:()=>d,DesignItemsIconsProvider:()=>K,DesignType:()=>q,DesignerCommandFactoryService:()=>T,DesignerLoaderService:()=>B,DesignerSchemaService:()=>M,DesignerSyncService:()=>x,DesignerViewNodeManipulationService:()=>X,DtSchemaApiService:()=>H,EntityDataSourceAttributeConfigProvider:()=>F,InterfaceDesignerUtilsModule:()=>j,LoadingPart:()=>G,MetaItemDesignSettingChangesApplierService:()=>w,MetaItemDesignSettingsService:()=>N,PAGE_PARAMETERS_ATTRIBUTE_PROPERTIES_DATA_PROVIDER_TOKEN:()=>he,PageParametersDataSourceAttributeConfigProvider:()=>k,ParameterControlDataValueTypeDesignConfig:()=>oe,RelatedPages:()=>ae,RelatedPagesFactory:()=>$,USE_DESIGNER_LOADER_MASK:()=>ue,ViewItemCommandExecutor:()=>O,executeCommand:()=>we,executeCommand$:()=>ce,getMacrosKey:()=>Z});var re=f(31134),a=f(94450);class j{}j.\u0275fac=function(e){return new(e||j)},j.\u0275mod=a.\u0275\u0275defineNgModule({type:j}),j.\u0275inj=a.\u0275\u0275defineInjector({imports:[re.CommonModule]}),function(){(typeof ngJitMode>"u"||ngJitMode)&&a.\u0275\u0275setNgModuleScope(j,{imports:[re.CommonModule]})}();var c=f(75378),d;(function(s){s.Input="crt.Input",s.NumberInput="crt.NumberInput",s.Checkbox="crt.Checkbox",s.Combobox="crt.ComboBox",s.DateTime="crt.DateTimePicker",s.Slider="crt.Slider",s.FileList="crt.FileList",s.Color="crt.ColorPicker",s.RichInput="crt.RichTextEditor",s.PhoneInput="crt.PhoneInput",s.EmailInput="crt.EmailInput",s.WebInput="crt.WebInput",s.ImageLink="crt.ImageInput",s.Timer="crt.Timer",s.LocalTime="crt.LocalTime",s.FileInput="crt.FileInput",s.Timeline="crt.Timeline"})(d||(d={}));const b="crt.DataSourceAttributePropertiesPanel",y={Input:{controlType:d.Input,viewModelAttributeName:"StringAttribute",propertiesPanelComponentTypeName:b},RichInput:{controlType:d.RichInput,viewModelAttributeName:"StringAttribute",propertiesPanelComponentTypeName:b},NumberInput:{controlType:d.NumberInput,viewModelAttributeName:"NumberAttribute",propertiesPanelComponentTypeName:b},Checkbox:{controlType:d.Checkbox,viewModelAttributeName:"BooleanAttribute",propertiesPanelComponentTypeName:b},Combobox:{controlType:d.Combobox,viewModelAttributeName:"LookupAttribute",propertiesPanelComponentTypeName:b},DateTime:{controlType:d.DateTime,viewModelAttributeName:"DateTimeAttribute",propertiesPanelComponentTypeName:b},Slider:{controlType:d.Slider,viewModelAttributeName:"SliderAttribute",propertiesPanelComponentTypeName:b},FileList:{controlType:d.FileList,viewModelAttributeName:"FileListAttribute",propertiesPanelComponentTypeName:b},Color:{controlType:d.Color,viewModelAttributeName:"ColorAttribute",propertiesPanelComponentTypeName:b},WebInput:{controlType:d.WebInput,viewModelAttributeName:"StringAttribute",propertiesPanelComponentTypeName:b},EmailInput:{controlType:d.EmailInput,viewModelAttributeName:"StringAttribute",propertiesPanelComponentTypeName:b},PhoneInput:{controlType:d.PhoneInput,viewModelAttributeName:"StringAttribute",propertiesPanelComponentTypeName:b},ImageLink:{controlType:d.ImageLink,viewModelAttributeName:"ImageLinkAttribute",propertiesPanelComponentTypeName:b},Timer:{controlType:d.Timer,viewModelAttributeName:"TimerAttribute",propertiesPanelComponentTypeName:b},LocalTime:{controlType:d.LocalTime,viewModelAttributeName:"LocalTimeAttribute",propertiesPanelComponentTypeName:b},Timeline:{controlType:d.Timeline,viewModelAttributeName:"LookupAttribute",propertiesPanelComponentTypeName:b}},se={Input:{...y.Input,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},RichInput:{...y.RichInput,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},NumberInput:{...y.NumberInput,propertiesPanelComponentTypeName:"crt.EntityDataSourceNumberAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Checkbox:{...y.Checkbox,propertiesPanelComponentTypeName:"crt.EntityDataSourceAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Combobox:{...y.Combobox,propertiesPanelComponentTypeName:"crt.EntityDataSourceLookupAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},DateTime:{...y.DateTime,propertiesPanelComponentTypeName:"crt.EntityDataSourceDateTimeAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Slider:{...y.Slider,propertiesPanelComponentTypeName:"crt.EntityDataSourceNumberAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},FileList:{...y.FileList,propertiesPanelComponentTypeName:"crt.FileListPropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Color:{...y.Color,propertiesPanelComponentTypeName:"crt.EntityDataSourceColorAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},WebInput:{...y.WebInput,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},EmailInput:{...y.EmailInput,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},PhoneInput:{...y.PhoneInput,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},ImageLink:{...y.ImageLink,propertiesPanelComponentTypeName:"crt.EntityDataSourceImageLookupAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Timer:{...y.Timer,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},LocalTime:{...y.LocalTime,propertiesPanelComponentTypeName:"crt.EntityDataSourceTextAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"},Timeline:{...y.Timeline,propertiesPanelComponentTypeName:"crt.EntityDataSourceLookupAttributePropertiesPanel",forwardReferencePropertiesPanelComponentTypeName:"crt.EntityForwardReferenceAttributePropertiesPanel"}},oe=y;class V{constructor(){this._convertableTypes=[c.DataValueType.SHORT_TEXT,c.DataValueType.MEDIUM_TEXT,c.DataValueType.MAXSIZE_TEXT,c.DataValueType.LONG_TEXT,c.DataValueType.PHONE_TEXT,c.DataValueType.WEB_TEXT,c.DataValueType.EMAIL_TEXT,c.DataValueType.RICH_TEXT]}getPropertiesPanelDataProviderToken(e){}get controlConfig(){return y}_getControlConfigByDataValueType(e){const t=["requirementType"];switch(e){case c.DataValueType.Text:case c.DataValueType.SHORT_TEXT:case c.DataValueType.MEDIUM_TEXT:case c.DataValueType.MAXSIZE_TEXT:case c.DataValueType.LONG_TEXT:case c.DataValueType.SECURE_TEXT:return{configType:"Input",editableProperties:[...t,"type"]};case c.DataValueType.Integer:case c.DataValueType.Float:case c.DataValueType.FLOAT1:case c.DataValueType.FLOAT2:case c.DataValueType.FLOAT3:case c.DataValueType.FLOAT4:case c.DataValueType.FLOAT8:case c.DataValueType.Money:return{configType:"NumberInput",editableProperties:[...t,"type"]};case c.DataValueType.Boolean:return{configType:"Checkbox",editableProperties:[]};case c.DataValueType.Lookup:return{configType:"Combobox",editableProperties:[...t,"referenceSchema"]};case c.DataValueType.Date:case c.DataValueType.DateTime:case c.DataValueType.Time:return{configType:"DateTime",editableProperties:[...t,"type"]};case c.DataValueType.Color:return{configType:"Color",editableProperties:t};case c.DataValueType.RICH_TEXT:return{configType:"RichInput",editableProperties:[...t,"type"]};case c.DataValueType.WEB_TEXT:return{configType:"WebInput",editableProperties:[...t,"type"]};case c.DataValueType.EMAIL_TEXT:return{configType:"EmailInput",editableProperties:[...t,"type"]};case c.DataValueType.PHONE_TEXT:return{configType:"PhoneInput",editableProperties:[...t,"type"]};case c.DataValueType.IMAGELOOKUP:return{configType:"ImageLink",editableProperties:[...t,"referenceSchema"]};default:return{configType:"Input",editableProperties:t}}}getAttributeEditablePropertiesByType(e){return this._getControlConfigByDataValueType(e).editableProperties}getConfigByType(e){const t=this._getControlConfigByDataValueType(e).configType,i=this.controlConfig[t];return i.propertiesPanelDataProviderToken=this.getPropertiesPanelDataProviderToken(e),i}getControlTypeToReplace(e,t){return this._convertableTypes.includes(e)?this.getConfigByType(e)?.controlType:t}}V.\u0275fac=function(e){return new(e||V)},V.\u0275prov=a.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"});var q;(function(s){s.ViewElement="ViewElement",s.ViewElementBinding="ViewElementBinding",s.DataSource="DataSource",s.DataSourceAttribute="DataSourceAttribute",s.Page="Page"})(q||(q={}));var I=f(49475),h=f(97600);class ae{constructor(e){this._pages=[],this._validateData(e),this._pages=(0,h.cloneDeep)(e)??[]}_validateData(e){const t=e?.filter(n=>n.IsDefault)??[];if(this._containsMultiplePagesForRole(t))throw new Error("There are multiple default pages for the same role");const i=e?.filter(n=>n.Actions?.Add)??[];if(this._containsMultiplePagesForRole(i))throw new Error("There are multiple add pages for the same role")}_containsMultiplePagesForRole(e){const t=[];for(const i of e)if(i.Role){if(t.includes(i.Role))return!0;t.push(i.Role)}return!1}_isSamePage(e,t,i){return e&&e.PageSchemaUId===t&&e.Role===i}_getDefaultPageByRole(e){const t=this._pages.filter(i=>i.IsDefault);return this._getPageByRole(t,e)}_getAddPageByRole(e){const t=this._pages.filter(i=>i.Actions?.Add);return this._getPageByRole(t,e)}_getPageByRole(e,t){return t===I.ALL_EMPLOYEES_SYSADMINUNIT_ID?e.find(i=>i.Role===t||(0,h.isEmpty)(i.Role)||i.Role===c.EMPTY_GUID):e.find(i=>i.Role===t)}_createNewDefaultPage(e,t){const i=this._initPageWithRole(e,t);this._applyIsDefault(i),this._pages.push(i)}_createNewAddPage(e,t){const i=this._initPageWithRole(e,t);this._applyPageAction(i,"Add"),this._pages.push(i)}_initPageWithRole(e,t){const i=this._getInitialPage(e);return this._applyRole(i,t),i}_getInitialPage(e){return{IsDefault:!1,IsSspDefault:!1,PageSchemaUId:e,UId:(0,c.generateGuid)(),Role:null}}_applyIsDefault(e){e.IsDefault=!0}_applyPageAction(e,t){(0,h.isEmpty)(e.Actions)&&(e.Actions={}),e.Actions[t]=!0}_updatePage(e,t,i){this._updatePageSchemaUId(e,t),e.Role||this._applyRole(e,i)}_applyRole(e,t){e.Role=t}_updatePageSchemaUId(e,t){e.PageSchemaUId=t}_removeDefaultPage(e,t){const i=this._pages.filter(n=>n.IsDefault);this._removePage(i,e,t)}_removeAddPage(e,t){const i=this._pages.filter(n=>n.Actions?.Add);this._removePage(i,e,t)}_removePage(e,t,i){const n=this._pages.indexOf(e.find(r=>r.PageSchemaUId===t&&r.Role===i));n>-1&&this._pages.splice(n,1)}_getPageUIdByRoleOrSspDefault(e,t){const i=t===I.ALL_PORTAL_USERS_SYSADMINUNIT_ID;return e.find(n=>!(0,h.isEmpty)(n.Role)&&n.Role!==c.EMPTY_GUID?n.Role===t:n.IsSspDefault===i)?.PageSchemaUId}getAddPageUIdByRole(e){const t=this._pages?.filter(i=>i.Actions?.Add);return this._getPageUIdByRoleOrSspDefault(t,e)}setAddPageUId(e,t){const i=this._getAddPageByRole(t);if(!this._isSamePage(i,e,t)){if(!e){this._removeAddPage(i?.PageSchemaUId,t);return}i?this._updatePage(i,e,t):this._createNewAddPage(e,t)}}getDefaultPageUIdByRole(e){const t=this._pages?.filter(i=>i.IsDefault);return this._getPageUIdByRoleOrSspDefault(t,e)}setDefaultPageUId(e,t){const i=this._getDefaultPageByRole(t);if(!this._isSamePage(i,e,t)){if(!e){this._removeDefaultPage(i?.PageSchemaUId,t);return}i?this._updatePage(i,e,t):this._createNewDefaultPage(e,t)}}setPageSchemaUIdByAction(e,t,i){if(t==="Add"){this.setAddPageUId(e,i);return}this.setDefaultPageUId(e,i)}equals(e){return(0,h.isEqual)(this._pages,e)}getMetaData(){return this._pages}}class ${create(e){return new ae(e)}}$.\u0275fac=function(e){return new(e||$)},$.\u0275prov=a.\u0275\u0275defineInjectable({token:$,factory:$.\u0275fac});class W{getControlExtraConfig(e,t,i=!1){let n=null;switch(e){case d.Input:t&&(n={multiline:i});break;case d.DateTime:switch(t){case c.DataValueType.DateTime:n={pickerType:"datetime"};break;case c.DataValueType.Date:n={pickerType:"date"};break;case c.DataValueType.Time:n={pickerType:"time"};break}break}return n}}W.\u0275fac=function(e){return new(e||W)},W.\u0275prov=a.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac,providedIn:"root"});var be=f(72856),ve=f(54514);class K{constructor(){this._iconRegistry=(0,a.inject)(be.MatIconRegistry),this._domSanitizer=(0,a.inject)(ve.DomSanitizer),this._iconNames=new Set}_getRegistryElementIcon(e){return c.InterfaceDesignerItemRegistry.get(e).toolbarConfig?.icon}registerIcon(e,t){return this._iconNames.has(e)||(this._iconRegistry.addSvgIconLiteral(e,this._domSanitizer.bypassSecurityTrustHtml(t)),this._iconNames.add(e)),e}registerIconByTypeAndGetIconName(e){const t=this._getRegistryElementIcon(e);return this.registerIcon(`page-designer-${e}`,t)}registerIconAndGetIconName(e){const t=this._iconNames.size;return this.registerIcon(`page-designer-${t}`,e)}}K.\u0275fac=function(e){return new(e||K)},K.\u0275prov=a.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac,providedIn:"root"});var Se=f(8239),v=f(2546),p=f(52045),_=f(21322),P=f(27049);class x{constructor(){this._observablesUIds=new Set,this._observablesSubject=new _.Subject}register(e){const t=(0,c.generateGuid)();return this._observablesUIds.add(t),e.pipe((0,P.tap)(()=>this._observablesUIds.delete(t)),(0,P.tap)(()=>this._observablesSubject.next()),(0,P.catchError)(i=>(this._observablesUIds.delete(t),this._observablesSubject.next(),(0,_.throwError)(()=>i))))}complete$(){const e=new Set(this._observablesUIds);return new _.Observable(t=>{if(this._observablesUIds.size===0)t.next(),t.complete();else{const i=this._observablesSubject.subscribe(()=>{e.forEach(n=>{this._observablesUIds.has(n)||e.delete(n)}),e.size===0&&(i.unsubscribe(),t.next(),t.complete())})}})}}x.\u0275fac=function(e){return new(e||x)},x.\u0275prov=a.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac});function we(s,e,t,i=new _.Subject){return(0,_.firstValueFrom)(ce(s,e,t,i))}function ce(s,e,t,i=new _.Subject,n=!0){return s.exists(e)?s.create(e,t).pipe((0,P.takeUntil)(i),(0,P.mergeMap)(r=>r.execute()),(0,P.map)(r=>r)):(n||console.error(`Command ${e} not found`),(0,_.of)({success:!1}))}class T{constructor(e){this._injector=e}static register(e,t){this._items.set(e,t)}static _getCommandType(e){return(0,_.of)(T._items.get(e))}static exists(e){return T._items.has(e)}exists(e){return T._items.has(e)||v.InterfaceDesignerCommandRegistry.items.has(e)}create(e,t){if(v.InterfaceDesignerCommandRegistry.items.has(e)){const i=this._injector.get(x),r=this._injector.get(p.SchemaApiService).schemaApi;return r.sync(),(0,_.of)(Reflect.construct(class{execute(){return(0,Se.Z)(function*(){const{instantiate:o}=v.InterfaceDesignerCommandRegistry.items.get(e);try{const u=o();return yield(0,_.lastValueFrom)(i.register((0,_.from)(u.execute(r,t)))),{success:!0}}catch(u){return console.error(e,u),{success:!1,errorMessage:u.message}}})()}},[]))}return T._getCommandType(e).pipe((0,P.tap)(i=>{if(!i)throw new TypeError(`Type ${e} is not defined`)}),(0,P.map)(i=>new i(this._injector,t)),(0,P.mergeMap)(i=>i.init()),(0,P.map)(i=>({execute:()=>(0,_.firstValueFrom)(i.execute())})))}}T._items=new Map,T.\u0275fac=function(e){return new(e||T)(a.\u0275\u0275inject(a.Injector))},T.\u0275prov=a.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac,providedIn:"root"});var Te=f(99293),G;(function(s){s[s.DataSourceLoaded=0]="DataSourceLoaded",s[s.ViewModelGenerated=1]="ViewModelGenerated"})(G||(G={}));const ue=new a.InjectionToken("CRT_USE_DESIGNER_LOADER_MASK");class B{constructor(e,t){this._maskService=e,this._showMask=t,this._loadingPartComplete$=new _.Subject,this._initParts(),this._subscribeLoadingPartComplete()}_subscribeLoadingPartComplete(){this._loadingPartComplete$.subscribe(({loadingPart:e,state:t})=>{this._loadingsParts.set(e,t);const i=[...this._loadingsParts.values()].every(Boolean);this._showMask&&(i?this._maskService.hideBodyMask():this._maskService.isVisible||this._maskService.showBodyMask({delay:0}))})}_initParts(){this._loadingsParts=new Map([[G.DataSourceLoaded,!1],[G.ViewModelGenerated,!1]])}completeLoadingPart(e){this._loadingPartComplete$.next({loadingPart:e,state:!0})}resetLoadingPart(e){this._loadingPartComplete$.next({loadingPart:e,state:!1})}}B.\u0275fac=function(e){return new(e||B)(a.\u0275\u0275inject(Te.MaskService),a.\u0275\u0275inject(ue,8))},B.\u0275prov=a.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"});var le=f(77207),De=f(41307),Ie=f(83612);class L{constructor(){this._connectedDropList=[],this.connectedDropList$=new _.BehaviorSubject([])}_removeDropList(e){this._connectedDropList=this._connectedDropList.filter(t=>t!==e)}add(e){this._connectedDropList.includes(e)&&this._removeDropList(e),this._connectedDropList.unshift(e),this.connectedDropList$.next([...this._connectedDropList])}remove(e){this._removeDropList(e),this.connectedDropList$.next([...this._connectedDropList])}}L.\u0275fac=function(e){return new(e||L)},L.\u0275prov=a.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"});class w{constructor(e){this._jsonApplierService=e}static _applyOperationByViewConfig(e,t,i){const n=t.settings.itemConfig,r=e.item.name===n?.name;if(r){const o=e.parent[e.propertyName];o instanceof Array&&i(o,e,t)}return r}static _insertValidate(e){if(!e.parentName)throw new Error('Invalid options, "parentName" is required.')}static _moveToIndexValidate(e){if(!e.parentName)throw new Error('Invalid options, "parentName" is required.');if(typeof e.index!="number")throw new Error('Invalid options, "index" is required.')}static _validate(e){switch(e.operation){case p.MetaItemDesignSettingChangesOperation.Insert:w._insertValidate(e);break;case p.MetaItemDesignSettingChangesOperation.MoveToIndex:w._moveToIndexValidate(e);break;default:break}}static _mergeConfigs(e,t){return(0,h.mergeWith)(e,t,(i,n)=>{(0,h.isArray)(i)&&(i.length=0,i.concat(n))})}_updateViewConfig(e,t){(0,p.iterateChildItems)(e,i=>!w._applyOperationByViewConfig(i,t,this._updateConfigInProperty),this)}_removeViewConfig(e,t){(0,p.iterateChildItems)(e,i=>!w._applyOperationByViewConfig(i,t,this._removeConfigInProperty),this)}_moveViewConfig(e,t){(0,p.iterateChildItems)(e,i=>!w._applyOperationByViewConfig(i,t,this._moveConfigInProperty),this)}_updateConfigInProperty(e,t,i){const n=e.findIndex(r=>r.name===t.item.name);e[n]=w._mergeConfigs(e[n],(0,h.cloneDeep)(i.settings.itemConfig)),i.settings.applyPropertiesStrategies?.forEach(r=>{if(r.value===p.ApplyChangedPropertyStrategy.Override){const o=r.propertyPath.replace("itemConfig.","");(0,h.set)(e[n],o,(0,h.cloneDeep)((0,h.get)(i.settings,r.propertyPath)))}})}_removeConfigInProperty(e,t){const i=e.findIndex(n=>n.name===t.item.name);e.splice(i,1)}_moveConfigInProperty(e,t,i){const n=e.findIndex(r=>r.name===t.item.name);e.splice(i.index,0,e.splice(n,1)[0])}_insertViewConfig(e,t){const i=t.parentPropertyName||"items";(0,p.iterateChildItems)(e,n=>{const r=n.item.name===t.parentName;return r&&((0,h.isUndefined)(t.index)?n.item[i].push(t.settings.itemConfig):n.item[i].splice(t.index,0,t.settings.itemConfig)),!r},this)}apply(e,t){const i=e.itemConfig;switch(w._validate(t),t.operation){case p.MetaItemDesignSettingChangesOperation.Insert:this._insertViewConfig(i,t);break;case p.MetaItemDesignSettingChangesOperation.Remove:this._removeViewConfig(i,t);break;case p.MetaItemDesignSettingChangesOperation.Update:case p.MetaItemDesignSettingChangesOperation.Move:this._updateViewConfig(i,t);break;case p.MetaItemDesignSettingChangesOperation.MoveToIndex:this._moveViewConfig(i,t);break;case p.MetaItemDesignSettingChangesOperation.MoveToContainer:this._removeViewConfig(i,t),this._insertViewConfig(i,t);break}return{itemConfig:i}}}w.\u0275fac=function(e){return new(e||w)(a.\u0275\u0275inject(p.JsonApplierService))},w.\u0275prov=a.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac});var ee=f(33177);const pe=new Map([["create","crt.AddViewItemCommand"],["update","crt.ChangeViewItemCommand"],["copy","crt.CopyViewItemCommand"],["delete","crt.RemoveViewItemCommand"]]);class O{constructor(e){this._commandFactoryService=e}_getViewItemCommand(e,t){return c.InterfaceDesignerItemRegistry.interfaceDesignerItemRegistrationInfos.get(e.type)?.designViewItemCommands?.[t]??pe.get(t)}add(e){return this._commandFactoryService.create(pe.get("create"),e)}change(e,t,i){const n=this._getViewItemCommand(e,"update");return this._commandFactoryService.create(n,{name:e.name,changes:t,selectOnCanvas:i})}copy({viewElement:e,index:t,propertyName:i,parentName:n,copyMetadata:r}){const o=this._getViewItemCommand(e,"copy");return this._commandFactoryService.create(o,{name:e.name,layoutConfig:e.layoutConfig,index:t,propertyName:i,parentName:n,copyMetadata:r})}remove(e){const t=this._getViewItemCommand(e,"delete");return this._commandFactoryService.create(t,{itemName:e.name})}}O.\u0275fac=function(e){return new(e||O)(a.\u0275\u0275inject(T))},O.\u0275prov=a.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"});function Z(s){return s.split(/[.-]/).join("")}class N{constructor(e,t,i){this._translateService=e,this._generateNameMacroProcessor=t,this._viewCommandExecutor=i,this._separator="_",this._defaultItemPropertyValues=(0,a.inject)(I.DEFAULT_ITEM_PROPERTY_VALUES,{optional:!0}),this._featureValues=(0,a.inject)(I.FEATURE_VALUES,{optional:!0})}static _generateName(e){const t=e.split(".").slice(1).join(".");return ee.NameGenerator.generateUnique(t)}_nestedSet(e,t,i){const n=t.split(this._separator),r=n.pop(),o=n.reduce((u,l)=>u[l]=u[l]||{},e);typeof o=="object"&&(o[r]=i)}_getPropertyPath(e){if(e.indexOf(this._separator)===-1)return e;const t=e.split(this._separator);return t.shift(),t.join(this._separator)}_isResourceMacros(e,t){return new RegExp("#ResourceString(.*"+t+".*)#$","g").test(e)}_setResourcesMacros(e,t,i){for(const[n,r]of Object.entries(e)){if((0,h.isEmpty)(r))continue;typeof r=="string"&&this._isResourceMacros(r,t)&&(e[n]=r.replace(t,i)),typeof r=="object"&&this._setResourcesMacros(r,t,i)}}_getResourceKeysByName(e,t){const i=Z(e);return Object.keys(t.strings).filter(n=>n.startsWith(i))}_copyResources(e,t,i,n){const r=Z(e.name),o=Z(t.name);this._setResourcesMacros(t,r,o);const u={strings:{}};let l=[];return typeof n?.applyPostfix=="object"&&(l=Object.keys(n.applyPostfix)),this._getResourceKeysByName(e.name,i).forEach(R=>{const A=i.strings[R],C=R.replace(r,o),g={};for(const[S,E]of Object.entries(A)){let U="";if(l.length){const J=l.findIndex(Y=>C.endsWith(Y));if(J>=0){const Y=n.applyPostfix[l[J]],ie=Y.translationKey;U=this._translateService.instant(ie),Y.parent&&delete n.applyPostfix[l[J]]}}g[S]=`${E}${U}`}u.strings[C]=g}),u}_removeResources(e,t){this._getResourceKeysByName(e,t).forEach(n=>{t.strings[n]=null})}_hasCopyDesignViewItemCommand(e){const i=c.InterfaceDesignerItemRegistry.get(e)?.designViewItemCommands?.copy;return Boolean(i)}_changeViewConfigPropertyValue(e,t,i,n){return(0,h.has)(e,t)&&(0,h.get)(e,t)===i?((0,h.set)(e,t,n),!0):!1}_changeItemName(e){const{viewConfig:t,resources:i,oldName:n,newName:r}=e,o=this._changeViewConfigPropertyValue(t,"name",n,r);if(this._changeViewConfigPropertyValue(t,"for",n,r),!!this._featureValues?.RenameResourcesWhenRenameComponent&&o&&i){const u=this._copyResources({name:n},t,i);this._removeResources(n,i),Object.assign(i.strings,u.strings)}}_processResources(e,t,i,n,r){const o=e.split(/[.-]/).join(""),u=this._translateService.currentLang,l={strings:{}},m=(0,ee.flattenObject)(n,this._separator);Object.entries(m||{}).forEach(([A,C])=>{const g=this._getPropertyPath(A),S=`${o}${this._separator}${g}`,E=this._translateService.instant(C);this._nestedSet(i,A,`#ResourceString(${S})#`),l.strings[S]={[u]:E}}),(0,I.getViewElementContentSlots)(t)?.forEach(A=>{const C=i?.[A];C&&Array.isArray(C)&&(i[A]=C.map(g=>{const E=g?.name||N._generateName(g.type);return this._processResources(E,g.type,g,g.defaultLocalizableStrings,l),delete g.defaultLocalizableStrings,g}))}),Object.assign(r.strings,l.strings)}_getDefaultPropertyValues(e){const t=(0,h.cloneDeep)(e.defaultPropertyValues)||{},i=this._defaultItemPropertyValues?.[e.type]||{};return Object.entries(i).forEach(([n,r])=>{t[n]=r}),t}create(e){const t=this._getDefaultPropertyValues(e);this._generateNameMacroProcessor.process(t);const i=e.type,n=t?.name||N._generateName(i),r={strings:{}};return this._processResources(n,i,t,e.defaultLocalizableStrings,r),{itemConfig:{name:n,type:i,...t},resources:r}}*copy({viewConfig:e,resources:t,layoutConfig:i,parentName:n,parentPropertyName:r,originalName:o,copyMetadata:u}){const l=e,m=(0,h.cloneDeep)(l);m.name=N._generateName(l.type),m.layoutConfig=(0,h.cloneDeep)(i);const R=this._copyResources(e,m,t,u),A=(0,I.getViewElementContentSlots)(l.type);A.forEach(C=>{l[C]&&(m[C]=[])}),yield[{itemConfig:m,resources:R},n,r,o];for(const C of A){const g=l[C];if(g)if(typeof g=="string")m[C]=g;else for(const S of g)this._hasCopyDesignViewItemCommand(S?.type)?this._viewCommandExecutor.copy({viewElement:S,index:S.index,propertyName:C,parentName:m.name,copyMetadata:u}).pipe((0,P.switchMap)(E=>E.execute()),(0,P.take)(1)).subscribe():yield*this.copy({viewConfig:S,resources:t,layoutConfig:S.layoutConfig,parentName:m.name,parentPropertyName:C,originalName:S.name,copyMetadata:u})}}rename(e){const{viewConfig:t,newName:i}=e;!i||((0,h.isArray)(t)?t.forEach(n=>this.rename({...e,viewConfig:n})):(this._changeItemName({...e,viewConfig:t}),(0,I.getViewElementContentSlots)(t.type).forEach(r=>{const o=t[r];o&&this.rename({...e,viewConfig:o})})))}remove({name:e,resources:t}){!this._featureValues?.DeleteResourcesWhenDeleteComponent||this._removeResources(e,t)}}N.\u0275fac=function(e){return new(e||N)(a.\u0275\u0275inject(le.TranslateService),a.\u0275\u0275inject(I.GenerateNameMacroProcessor),a.\u0275\u0275inject(O))},N.\u0275prov=a.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac});class M extends p.SchemaService{constructor(e,t,i,n,r,o,u,l){super(l),this._connectedDropListService=e,this._designerLoaderService=t,this._metaItemDesignSettingsService=i,this._changesApplierService=n,this._sysSettingsService=r,this._userInfo=o,this._translateService=u,this._schemaApiService=(0,a.inject)(p.SchemaApiService),this._namePrefix=null}_getNamePrefix(){return this._namePrefix!=null?(0,_.of)(this._namePrefix):this._sysSettingsService.getValueByCode("SchemaNamePrefix","").pipe((0,P.tap)(e=>this._namePrefix=e))}_applyChanges(e){const t={itemConfig:this._schema?.viewConfig};this._changesApplierService.apply(t,e)}_getRootNames(){const e=this._schema?.viewConfig;return(0,Ie.isArray)(e)?e.map(t=>t.name):[e?.name]}_publishSchemaChanged(e,t){this.schemaChanged$.next({schema:this._schema,changes:e,restored:t})}_applyParameterChanges(e,t){t?.forEach(i=>{Object.prototype.hasOwnProperty.call(e,i.path)&&(e[i.path]=i.value)})}_getUniqueName(e,t){let i=0,n;do i++,n=`${e}${i}`;while(t.find(r=>r===n));return n}_getLocalizedCaptions(e){const t=[];return Object.entries(e).forEach(([i,n])=>{t.push(n.caption)}),t}_getNewParameterName(e,t){const i=Object.keys(t);return this._getUniqueName(e,i)}_emitAttributeChanged(){this.injector.get(I.FEATURE_VALUES).UseDesignerHotSwapViewModel&&this.schemaChanged$.next({schema:this._schema,changes:{viewConfig:this._schema.viewConfig,operation:p.MetaItemDesignSettingChangesOperation.AttributeChanged}})}setViewModelAttribute(e,t){super.setViewModelAttribute(e,t),this._emitAttributeChanged()}updateViewModelAttribute(e,t){super.updateViewModelAttribute(e,t),this._emitAttributeChanged()}removeViewModelAttribute(e){super.removeViewModelAttribute(e),this.injector.get(I.FEATURE_VALUES).EnableSchemaServiceRemoveViewModelAttribute&&this._emitAttributeChanged()}createViewModelAttribute(e,t){super.createViewModelAttribute(e,t),this._emitAttributeChanged()}isRootContainer(e){return this._getRootNames().includes(e)}create({defaultViewConfig:e={},defaultConfig:t,parentName:i,propertyName:n,index:r}){const o=this._metaItemDesignSettingsService.create(t);o.itemConfig={...e,...o.itemConfig};const u=p.MetaItemDesignSettingChangesOperation.Insert;this._applyChanges({settings:o,operation:u,parentName:i,parentPropertyName:n,index:r}),this.updateResources(o.resources);const l=o.itemConfig,m={viewConfig:l,operation:u,parentName:i,propertyName:n,index:r};return this._publishSchemaChanged(m),l}update({itemConfig:e,resources:t,modelConfig:i,viewModelConfig:n,applyPropertiesStrategies:r,selectOnCanvas:o=!0}){const u=p.MetaItemDesignSettingChangesOperation.Update;this._applyChanges({settings:{itemConfig:e,applyPropertiesStrategies:r},operation:u}),this.updateResources(t),this.updateModelConfig(i),this.updateSchemaViewModelConfig(n);const l=this.getViewConfigInfoByName(e.name),R={viewConfig:l.viewConfig||[],operation:u,selectOnCanvas:o,parentName:l.parentName};this._publishSchemaChanged(R)}remove(e){const{viewConfig:t,parentName:i,index:n}=this.getViewConfigInfoByName(e);if(!t)return;const r=p.MetaItemDesignSettingChangesOperation.Remove;this._applyChanges({settings:{itemConfig:t},operation:r}),this._metaItemDesignSettingsService.remove({name:e,resources:this._schema.resources});const o={viewConfig:t,operation:r,parentName:i,index:n};this._publishSchemaChanged(o),this._connectedDropListService.remove(e)}rename(e,t){this._metaItemDesignSettingsService.rename({viewConfig:this._schema.viewConfig,resources:this._schema.resources,oldName:e,newName:t});const{viewConfig:i,parentName:n,parentPropertyName:r,index:o}=this.getViewConfigInfoByName(t);if(n){const u=p.MetaItemDesignSettingChangesOperation.Rename;this._publishSchemaChanged({viewConfig:i,parentName:n,operation:u,oldName:e,propertyName:r,index:o})}}copy(e,t,i,n,r,o){const u=n,{parentName:l,parentPropertyName:m,viewConfig:R}=this.getViewConfigInfoByName(e),A=this._schema.resources,C=this._metaItemDesignSettingsService.copy({viewConfig:R,layoutConfig:t,resources:A,parentName:o||l,parentPropertyName:i||m,copyMetadata:r,originalName:R.name});let g=null,S=null,E;do{if(E=C.next(),E.done){const{viewConfig:Fe}=this.getViewConfigInfoByName(S),ke={viewConfig:Fe,operation:p.MetaItemDesignSettingChangesOperation.Insert,parentName:o||l,propertyName:m,index:u};this._publishSchemaChanged(ke);break}const[U,J,Y,ie]=E.value;S=S??U?.itemConfig?.name;const Oe=n??this.getViewConfigInfoByName(ie).index;this._applyChanges({settings:{itemConfig:U.itemConfig},operation:p.MetaItemDesignSettingChangesOperation.Insert,parentName:J,parentPropertyName:Y,index:Oe}),this.updateResources(U.resources),n=null,g??(g=U.itemConfig)}while(!E.done);return g}undo(e){const{viewConfig:t,operation:i,parentName:n,index:r}=e;this._applyChanges({settings:{itemConfig:t},index:r,operation:i,parentName:n});const o={viewConfig:t,parentName:n,operation:i,index:r};this._publishSchemaChanged(o,!0)}move(e,t){const i=p.MetaItemDesignSettingChangesOperation.Move;let{viewConfig:n}=this.getViewConfigInfoByName(e);n={...n,layoutConfig:t},this._applyChanges({settings:{itemConfig:n},operation:i}),this._publishSchemaChanged({viewConfig:n,operation:i})}moveToIndex(e,t){const{viewConfig:i,parentName:n}=this.getViewConfigInfoByName(e),r=p.MetaItemDesignSettingChangesOperation.MoveToIndex;this._applyChanges({settings:{itemConfig:i},index:t,operation:r,parentName:n}),this._publishSchemaChanged({viewConfig:i,parentName:n,operation:r})}moveToContainer({name:e,index:t,parentName:i,parentPropertyName:n,layoutConfig:r}){const o=this.getViewConfigInfoByName(e).viewConfig;r?o.layoutConfig=r:delete o.layoutConfig;const u=p.MetaItemDesignSettingChangesOperation.MoveToContainer;this._applyChanges({settings:{itemConfig:o},index:t,operation:u,parentName:i,parentPropertyName:n});const l={viewConfig:o,parentName:i,propertyName:n,operation:u,index:t};this._publishSchemaChanged(l),this._connectedDropListService.add(o.name)}updateResources(e){var t,i;!this._schema||((t=this._schema).resources??(t.resources={strings:{}}),(i=this._schema.resources).strings??(i.strings={}),!((0,h.isEqual)(this._schema.resources,e)||(0,h.isEmpty)(e?.strings))&&Object.entries(e.strings).forEach(([n,r])=>{this._schema.resources.strings[n]=r}))}createDataSource(e,t){(!t?.hiddenInPageDesigner||t?.scope===c.DataSourceScope.Page)&&this._designerLoaderService.resetLoadingPart(G.DataSourceLoaded),super.createDataSource(e,t)}updateParameter(e,t){const i=this._schema.parameters,n=i[e];if(!n)return(0,_.of)(null);this._applyParameterChanges(n,t),delete i[e],i[n.name]=n;const r=p.MetaItemDesignSettingChangesOperation.ParameterChanged;return this._publishSchemaChanged({operation:r,viewConfig:this._schema.viewConfig}),(0,_.of)(n)}_getDataValueTypeNewAttributesCount(e,t,i){return e.filter(n=>n.find(r=>r.cultureName===t&&r.value?.startsWith(i))).length}_getNewParameterCaption(e,t,i){const n=i??`${c.DataValueType[t]}Parameter`,r=this._translateService.instant(`NewParameterSubGroup.${n}`),o=this._userInfo.cultureInfo.sysCultureName,u=this._getLocalizedCaptions(e),l=this._getDataValueTypeNewAttributesCount(u,o,r);return{cultureName:o,value:r+" "+(l+1)}}_rebindViewConfigs(e,t){this.getViewConfigInfoByFilter(n=>{const r=c.ViewElementRegistry.getFormControlRelatesAttribute(n.type);return n[r]?.startsWith(`$${e}`)}).forEach(n=>{const r=c.ViewElementRegistry.getFormControlRelatesAttribute(n.viewConfig.type),u=n.viewConfig[r].replace(`$${e}`,`$${t}`);this.update({itemConfig:{[r]:u,name:n.viewConfig.name,label:`$Resources.Strings.${t}`},selectOnCanvas:!1})})}createParameter(e,t,i){return this._getNamePrefix().pipe((0,P.map)(n=>{const r=this._schema.parameters,o=this._getNewParameterName(n+e,r),u=new I.LocalizableStringArray([this._getNewParameterCaption(r,t,i?.captionKey)]),l={uId:(0,c.generateGuid)(),name:o,caption:u,dataValueType:t,required:!1,isOwnParameter:!0,referenceSchemaUId:c.EMPTY_GUID};r[l.name]=l;const m=p.MetaItemDesignSettingChangesOperation.ParameterChanged;return this._publishSchemaChanged({operation:m,viewConfig:this._schema.viewConfig}),l}))}removeParameter(e){const t=this._schema.parameters;delete t[e];const i=p.MetaItemDesignSettingChangesOperation.ParameterChanged;this._publishSchemaChanged({operation:i,viewConfig:this._schema.viewConfig})}renameViewModelAttribute(e,t){if(!this.isViewModelAttributeExists(e))throw new Error(`ViewModel does not contain attribute with name '${e}'`);const i=this.getViewModelAttributesConfig();i[t]=i[e],delete i[e],this._rebindViewConfigs(e,t)}init(e){this.initialSchema=(0,h.cloneDeep)(e),this._schemaApiService.init(e),super.init(e)}}M.\u0275fac=function(e){return new(e||M)(a.\u0275\u0275inject(L),a.\u0275\u0275inject(B),a.\u0275\u0275inject(N),a.\u0275\u0275inject(w),a.\u0275\u0275inject(De.SysSettingsService),a.\u0275\u0275inject(I.UserInfo),a.\u0275\u0275inject(le.TranslateService),a.\u0275\u0275inject(a.Injector))},M.\u0275prov=a.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac});class X{constructor(e){this._designerSchemaService=e}remove(e){this._designerSchemaService.remove(e.name)}update(e,{itemConfig:t,resources:i,viewModelConfig:n,applyPropertiesStrategies:r,selectOnCanvas:o=!0}){this._designerSchemaService.update({itemConfig:t,resources:i,viewModelConfig:n,applyPropertiesStrategies:r,selectOnCanvas:o})}create(e){return this._designerSchemaService.create(e)}}X.\u0275fac=function(e){return new(e||X)(a.\u0275\u0275inject(M))},X.\u0275prov=a.\u0275\u0275defineInjectable({token:X,factory:X.\u0275fac});class F extends V{get controlConfig(){return se}}F.\u0275fac=function(){let s;return function(t){return(s||(s=a.\u0275\u0275getInheritedFactory(F)))(t||F)}}(),F.\u0275prov=a.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"});const he=new a.InjectionToken("PageParametersAttributePropertiesDataProvider");class k extends V{get controlConfig(){return oe}getPropertiesPanelDataProviderToken(e){return he}}k.\u0275fac=function(){let s;return function(t){return(s||(s=a.\u0275\u0275getInheritedFactory(k)))(t||k)}}(),k.\u0275prov=a.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"});class Ae{constructor(e){this.injector=e}injectDependencies(){return(0,_.of)(null).pipe((0,P.tap)(()=>{this.designerSchemaService=this.injector.get(M),this._designerSyncService=this.injector.get(x)}))}execute(){return this._designerSyncService.register(this.innerExecute()).pipe((0,P.catchError)(e=>(console.log(`Command execution error!
CommandType: ${this.constructor.name}.
Error: ${e.message}`),(0,_.of)({success:!1,errorMessage:e.message}))))}init(){return this.injectDependencies().pipe((0,P.map)(()=>this))}}function Ee(){throw new Error("Object is destroyed")}function te(s){const e=new Set;for(let t=s;t!=null;t=Object.getPrototypeOf(t)){const i=Object.getOwnPropertyNames(t);for(const n of i)typeof t[n]=="function"&&e.add(n)}for(const t of e)s[t]=Ee}class D{constructor(){this.injector=(0,a.inject)(a.EnvironmentInjector)}instantiate(e,t){return this.injector.runInContext(()=>new e(...t))}destroy(){te(this)}}class me extends D{constructor(e){super(),this._config=e,this.type=v.DataSourceType.EntityDataSource,this.sync(e)}addAttribute(e){throw new Error("Method not implemented.")}getAttribute(e){throw new Error("Method not implemented.")}removeAttribute(e){throw new Error("Method not implemented.")}sync(e){this._config=e,this.entitySchemaName=e.config.entitySchemaName}}function de(s,e,t,i,n){const r=new Map(s.map(o=>[e(o),o]));t.forEach((o,u)=>{const l=i(o);if(r.has(l)){const m=r.get(l);r.delete(l),s[u]=n.update(m,o)||m}else s[u]=n.create(o)}),r.forEach(n.destroy),s.length=t.length}function Q(s,e,t){const i=new Map(s);for(const n in e){let r;s.has(n)?(i.delete(n),r=s.get(n),r=t.update(r,e[n],n)||r):r=t.create(e[n],n),s.set(n,r)}for(const[n,r]of i)s.delete(n),t.destroy(r)}class Ne extends D{constructor(e){super(),this._config=e,this._designerService=(0,a.inject)(M),this._dataSources=new Map,this.sync(e)}_addEntityDataSource(e,t,i){const n=i.map(u=>[u,{path:u}]),r={type:v.DataSourceType.EntityDataSource,scope:c.DataSourceScope.ViewElement,config:{entitySchemaName:t,attributes:n}};this._designerService.createDataSource(e,r);const o=this.instantiate(me,[this._config.dataSources[e]]);return this._dataSources.set(e,o),o}addDataSource(e,t){if(t.type===v.DataSourceType.EntityDataSource)return this._addEntityDataSource(e,t.entitySchemaName,t.columns);throw new Error("Method not implemented")}getDataSource(e){return this._dataSources.get(e)}getAllDataSources(){return this._dataSources}canRemoveDataSource(e){return!this._designerService.isDataSourceBound(e)}hasDataSource(e){return this._dataSources.has(e)}removeDataSource(e){this._designerService.removeUnboundDataSource(e),this._dataSources.delete(e)}getPrimaryDataSourceName(){return this._designerService.getPrimaryDataSourceName()}sync(e){this._config=e,Q(this._dataSources,e.dataSources,{create:t=>{if(t.type===v.DataSourceType.EntityDataSource)return this.instantiate(me,[t]);console.error(t.type,"Not implemented")},update:(t,i)=>t?.sync(i),destroy:t=>t?.destroy()})}}class ge extends D{constructor(e){super(),this._expression=e,this.type=v.BindingType.Attribute;const t=(0,p.parseExpression)(this._expression);this.attributePath=t.attributePath}}class Me extends D{constructor(e){super(),this.value=e,this.type=v.BindingType.Const}}class Re extends D{constructor(e){super(),this._config=e,this.type=v.BindingType.Request,this.requestType=this._config.request}}class Ve extends D{constructor(e){super(),this._expression=e,this.type=v.BindingType.Resource;const t=(0,p.parseExpression)(this._expression);this.resourcePath=t.resourcePath}}class z extends D{constructor(e,t){super(),this._config=e,this._parent=t,this._manipulationService=(0,a.inject)(p.ViewNodeManipulationService),this._bindings=new Map,this._content=new Map,this.type=this._config.type,this.name=this._config.name,this._viewElementsRegistryItem=c.ViewElementRegistry.viewElements.get(this.type),this._contentSlotNames=(this._viewElementsRegistryItem?.contentSlots??[]).map(i=>typeof i=="string"?i:i.name),this.sync(this._config)}_syncContent(){Q(this._content,this._contentConfig,{create:e=>e.map(t=>this.instantiate(z,[t,this])),update:(e,t)=>de(e,i=>i.name,t,i=>i.name,{create:i=>this.instantiate(z,[i,this]),update:(i,n)=>i.sync(n),destroy:i=>i.destroy()}),destroy:e=>e.forEach(t=>t.destroy())})}_syncBindings(){const e=(i,n)=>{if(this._isOutputProperty(n))return this.instantiate(Re,[i]);if((0,p.isBindingExpression)(i)){const r=(0,p.parseExpression)(i);if(r.attributePath)return this.instantiate(ge,[i]);if(r.resourcePath)return this.instantiate(Ve,[i])}else return this.instantiate(Me,[i])},t=i=>i.destroy();Q(this._bindings,this._propertiesConfig,{create:e,destroy:t,update:(i,n,r)=>(t(i),e(n,r))})}_isOutputProperty(e){return Boolean(this._viewElementsRegistryItem?.outputs?.[e])}remove(){this._parent.removeChild(this.name)}removeChild(e){for(const t of this._content.values()){const i=t.findIndex(n=>n.name===e);if(i>-1){this._manipulationService.remove(t[i]),t[i].destroy(),t.splice(i,1);return}}}getChildren(){return Array.from(this._content.values()).flatMap(e=>e)}getBinding(e){return this._bindings.get(e)}bindProperty(e,t){this._bindings.has(e)&&(this._bindings.get(e).destroy(),this._bindings.delete(e));const i="$"+t.toAttribute;this._manipulationService.update(this,{itemConfig:{...this._config,[e]:i},resources:null,viewModelConfig:null,applyPropertiesStrategies:null});const n=this.instantiate(ge,[i]);return this._bindings.set(e,n),n}sync(e){this._config=e,this._contentConfig=(0,h.pick)(this._config,this._contentSlotNames),this._syncContent(),this._propertiesConfig=(0,h.omit)(this._config,this._contentSlotNames),this._syncBindings()}createChild(e){const t=this._manipulationService.create({parentName:this.name,...e}),i=this._content.get(e.slotName),n=this.instantiate(z,[t,this]);return i.push(n),n}}class xe extends D{constructor(e){super(),this._config=e,this._manipulationService=(0,a.inject)(p.ViewNodeManipulationService),this._nodes=[],this.sync(this._config)}sync(e){de(this._nodes,t=>t.name,e,t=>t.name,{create:t=>this.instantiate(z,[t,this]),update:(t,i)=>t.sync(i),destroy:t=>t.destroy()})}getNodeByName(e,t=this._nodes){for(const i of t){if(i.name===e)return i;const n=this.getNodeByName(e,i.getChildren());if(n)return n}return null}findNodes(e,t=this._nodes){const i=[];for(const n of t){e(n)&&i.push(n);const r=this.findNodes(e,n.getChildren());i.push(...r)}return i}createNode(e,t){const i=this._manipulationService.create({...t,parentName:e}),n=this.instantiate(z,[i,this]);return this._nodes.push(n),n}removeChild(e){const t=this._nodes.findIndex(i=>i.name===e);t>-1&&(this._manipulationService.remove(this._nodes[t]),this._nodes[t].destroy(),this._nodes.splice(t,1))}}class fe extends D{constructor(e){super(),this._config=e,this.path=this._config.path,[this.dataSourceName,this.dataSourceAttributePath]=this.path.split(/\.(.*)/s)}}class ye extends D{get value(){return this._config?.value}set value(e){this._config.value=e}constructor(e,t){super(),this.name=e,this.attributeConfig=t,this.type=v.ViewModelAttributeType.Simple,this.sync(t)}bindToModel(e,t){if(this.hasModelBinding())throw new Error("Attribute already bound to model.");return this._config.modelConfig={path:e+"."+t},this._modelBinding=this.instantiate(fe,[this._config.modelConfig]),this._modelBinding}unbindFromModel(){delete this._config.modelConfig,this._modelBinding?.destroy(),this._modelBinding=null}getModelBinding(){return this._modelBinding}hasModelBinding(){return Boolean(this._modelBinding)}sync(e){this._config=e,this._modelBinding&&(!e.modelConfig||e.modelConfig.path!==this._modelBinding.path)&&(this._modelBinding.destroy(),this._modelBinding=null),e.modelConfig&&!this._modelBinding&&(this._modelBinding=this.instantiate(fe,[e.modelConfig]))}}class je{constructor(e){this._config=e,this.type="unknown"}sync(e){this._config=e}destroy(){te(this)}}class _e extends D{constructor(){super(...arguments),this.attributes=new Map,this.designerSchemaService=(0,a.inject)(M)}instantiateAttribute(e,t){return Object.getOwnPropertyNames(t).every(n=>["value","modelConfig"].includes(n))?this.instantiate(ye,[e,t]):this.instantiate(je,[t])}createAttribute(e,t){var i;if(this.hasAttribute(e))throw new Error(`ViewModel already contain attribute with name '${e}'`);(i=this.vmConfig).attributes??(i.attributes={});const n={value:t};this.vmConfig.attributes[e]=n;const r=this.instantiate(ye,[e,n]);return this.attributes.set(e,r),r}hasAttribute(e){const t=e.split(".");if(t.length===1)return this.attributes.has(t[0]);const i=this.getAttribute(t.slice(0,-1).join("."));if(i.type!==v.ViewModelAttributeType.ViewModelCollection)throw new Error(`Wrong attribute path: '${e}'`);return i.hasAttribute(t.at(-1))}getAttribute(e){const t=e.split("."),i=this.attributes.get(t[0]);if(t.length===1)return i;if(i.type!==v.ViewModelAttributeType.ViewModelCollection)throw new Error(`Wrong attribute path: '${e}'`);return i.getAttribute(t.slice(1).join("."))}getAllAttributes(){return this.attributes}removeAttribute(e){const t=e.split(".");if(t.length===1){delete this.vmConfig.attributes[t[0]],this.attributes.delete(t[0]);return}const i=this.getAttribute(t.slice(0,-1).join("."));if(i.type!==v.ViewModelAttributeType.ViewModelCollection)throw new Error(`Wrong attribute path: '${e}'`);return i.removeAttribute(t.at(-1))}canRemoveAttribute(e){return!this.designerSchemaService.isViewModelAttributeBound(e)}sync(e){this.vmConfig=e,Q(this.attributes,e.attributes,{create:(t,i)=>this.instantiateAttribute(i,t),update:(t,i)=>t.sync(i),destroy:t=>t.destroy()})}destroy(){this.attributes.forEach(e=>{e.destroy()}),this.attributes.clear(),te(this)}}class Ce extends D{constructor(e){super(),this._config=e,this.dataSourceName=this._config.path.split(".")[0]}}class Pe extends _e{constructor(e,t){super(),this.name=e,this.attributeConfig=t,this.type=v.ViewModelAttributeType.ViewModelCollection,this.sync(t)}unbindFromModel(){delete this.attributeConfig.modelConfig,this._modelBinding.destroy(),this._modelBinding=null}bindToModel(e,t){return this.designerSchemaService.bindViewModelAttributeCollection(this.name,e,t,"",0),this._modelBinding=this.instantiate(Ce,[this.attributeConfig.modelConfig]),this._modelBinding}getModelBinding(){return this._modelBinding}hasModelBinding(){return Boolean(this._modelBinding)}sync(e){this.attributeConfig=e,super.sync(e.viewModelConfig),this._modelBinding&&(!e.modelConfig||e.modelConfig.path!==this._modelBinding.dataSourceName)&&(this._modelBinding.destroy(),this._modelBinding=null),e.modelConfig&&!this._modelBinding&&(this._modelBinding=this.instantiate(Ce,[e.modelConfig]))}}class Be extends _e{constructor(e){super(),this.vmConfig=e,this.sync(e)}instantiateAttribute(e,t){return"viewModelConfig"in t&&t.isCollection?this.instantiate(Pe,[e,t]):super.instantiateAttribute(e,t)}createViewModelCollectionAttribute(e){var t;if(this.hasAttribute(e))throw new Error(`ViewModel already contain attribute with name '${e}'`);(t=this.vmConfig).attributes??(t.attributes={});const i={isCollection:!0,viewModelConfig:{attributes:{}}};this.vmConfig.attributes[e]=i;const n=this.instantiate(Pe,[e,i]);return this.attributes.set(e,n),n}}class Le extends D{get view(){return this._view||(this._view=this.instantiate(xe,[this._schema.viewConfig])),this._view}get viewModel(){return this._viewModel||(this._viewModel=this.instantiate(Be,[this._schema.viewModelConfig])),this._viewModel}get model(){return this._model||(this._model=this.instantiate(Ne,[this._schema.modelConfig])),this._model}constructor(e){super(),this._schema=e}sync(){this.view.sync(this._schema.viewConfig),this.viewModel.sync(this._schema.viewModelConfig),this.model.sync(this._schema.modelConfig)}}class H{constructor(){this._debugPropertyPath="creatio.debugging.__schemaApi__",this._injector=(0,a.inject)(a.EnvironmentInjector),this._window=(0,a.inject)(ee.WINDOW_TOKEN)}get schemaApi(){return this._schemaApi}init(e){this._injector.runInContext(()=>{this._schemaApi=new Le(e),(0,h.set)(this._window,this._debugPropertyPath,this._schemaApi)})}ngOnDestroy(){(0,h.set)(this._window,this._debugPropertyPath,null)}}H.\u0275fac=function(e){return new(e||H)},H.\u0275prov=a.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac})}}]);
