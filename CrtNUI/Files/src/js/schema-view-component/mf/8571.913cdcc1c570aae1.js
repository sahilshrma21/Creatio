(self.webpackChunkapp_studio_enterprise_schema_view=self.webpackChunkapp_studio_enterprise_schema_view||[]).push([[8571],{78571:(Be,de,g)=>{g.r(de),g.d(de,{BaseDataGridColumnEditHandler:()=>P,BaseDataGridStateHandlerService:()=>Y,BooleanCellViewElementConfigCreator:()=>Z,BooleanEditingCellViewElementConfigCreator:()=>G,CAN_CREATE_DEFAULT_GRID_SETTING_OPERATION_CODE:()=>we,CHECK_DATA_GRID_COLUMNS_RIGHTS_ON_LOAD:()=>he,CellViewElementConfigCreator:()=>E,CrtDataGridCdkModule:()=>S,DATA_GRID_AVAILABLE_EDITING_DATA_VALUE_TYPES:()=>Ee,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>ie,DATA_GRID_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Ne,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>fe,DATA_GRID_EDITING_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Re,DISABLE_DATA_GRID_EDITING_MODE_FEATURE_CODE:()=>ve,DISABLE_DATA_GRID_MULTIPLE_ROWS_SELECTION_FEATURE_CODE:()=>Ae,DataGridCancelItemsChangesHandler:()=>oe,DataGridCancelItemsChangesRequest:()=>se,DataGridColumnDefinitionService:()=>K,DataGridRowDoubleClickHandler:()=>ce,DataGridRowDoubleClickRequest:()=>ue,DateTimeCellViewElementConfigCreator:()=>j,DateTimeEditingCellViewElementConfigCreator:()=>R,DcmStageCellViewElementConfigCreator:()=>w,DcmStageEditingCellViewElementConfigCreator:()=>O,EditingCellViewElementConfigCreator:()=>_,EmailCellViewElementConfigCreator:()=>V,EmailEditingCellViewElementConfigCreator:()=>M,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY:()=>pe,FILE_LIST_CELL_VIEW_CONFIG_CREATOR_FACTORY_PROVIDER:()=>Ge,FileCellViewElementConfigCreator:()=>I,FileSizeCellViewElementConfigCreator:()=>v,GRID_VIEW_ELEMENT_TYPES:()=>me,LookupCellViewElementConfigCreator:()=>H,LookupEditingCellViewElementConfigCreator:()=>N,NativeLinkCellViewElementConfigCreator:()=>z,NumericCellViewElementConfigCreator:()=>k,NumericEditingCellViewElementConfigCreator:()=>F,PhoneCellViewElementConfigCreator:()=>T,PhoneEditingCellViewElementConfigCreator:()=>L,PrimaryCellViewElementConfigCreator:()=>W,RichTextCellViewElementConfigCreator:()=>A,SchemaDataGridColumnEditHandler:()=>Q,SchemaDataGridColumnSelectionService:()=>q,StructureExplorerDataGridColumnSelectionService:()=>J,TextCellViewElementConfigCreator:()=>B,TextEditingCellViewElementConfigCreator:()=>b,WebEditingCellViewElementConfigCreator:()=>x,getDataGridViewConfigs:()=>Ce,getDataGridViewConfigsWithItemsBinding:()=>De,getViewModelItemsAttributeName:()=>re});var o=g(94450),y=g(14537),X=g(52045),m=g(21322),C=g(27049);function re(r){const{items:e}=r||{};if(typeof e!="string"){console.log(`The type '${typeof e}' of 'items' attribute binding value is not supporting.`);return}if(e.startsWith("$")===!1){console.log(`The attribute value '${e}' of the 'items' is not supporting. The attribute value should be bindable (starts with a "$" character)`);return}return e.substring(1)}var f=g(49475);const me=["crt.DataGrid","crt.FileList","crt.ApprovalList"];function Ce(r,e){const{viewConfig:t}=r;return e=e&&e.length>0?e:void 0,f.MetadataSchemaUtils.getViewConfigInfoByPropertyForValues("type",e||me,t).filter(n=>Boolean(n)).map(({viewConfig:n})=>n).filter(({name:n})=>n)||[]}function De(r,e){const{viewModelConfig:t}=r;return Ce(r,e).filter(({items:n})=>(0,y.isBindToViewModelAttribute)(n,t.attributes))}class Y{get viewModel$(){return this.injector?this.injector.get(y.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)):(0,m.of)(null)}constructor(e){this.schemaService=e}getColumnsFromSchema(e){const t=e?.columns??[];if(typeof t=="string"){const n=t.split("$").pop();return this.viewModel$.pipe((0,C.map)(i=>(i?.attributes??{})[n]||[]))}return(0,m.of)(t)}getDataSourceName(e){const t=re(e);return this.viewModel$.pipe((0,C.map)(n=>n?.getBoundDataSourceNameByAttributePath(t)))}handle(e,t){this.injector=t;const n=t.get(y.VIEW_ELEMENT_CONFIG),i=this.schemaService.getViewConfigInfoByName(n.name).viewConfig,a=e.columns??[];return this.getDataSourceName(i).pipe((0,C.switchMap)(l=>l?this.getColumnsFromSchema(i).pipe((0,C.switchMap)(s=>{const d={viewElementConfig:i,dataSourceName:l,columns:a,previousColumns:s};return this.innerHandle(d)})):(0,m.of)(void 0)))}}Y.\u0275fac=function(e){return new(e||Y)(o.\u0275\u0275inject(X.SchemaService))},Y.\u0275prov=o.\u0275\u0275defineInjectable({token:Y,factory:Y.\u0275fac});var u=g(8239),c=g(75378),ge=g(77207),Se=g(59929),D=g(34038),$=g(97600);class P{constructor(e){this._translateService=e.get(ge.TranslateService),this._columnEditService=e.get(D.DataGridColumnEditService),this._entitySchemaService=e.get(f.EntitySchemaService),this._entitySchemaProvider=e.get(f.EntitySchemaProvider),this.schemaService=e.get(X.SchemaService)}_replaceColumn(e,t,n){if(!e)return n;const i=(0,$.findIndex)(n,a=>a.id===t);return n[i]={...e,changed:!0},n}_getEntitySchemaName(e,t){if(!e)return null;const i=t.getBoundDataSchemaByAttributePath(e)?.dataSourceConfig;return i?.type!=="crt.EntityDataSource"?null:i.config?.entitySchemaName}getResources(e,t){return Promise.resolve(this.schemaService.resources)}processColumns(e,t,n){var i=this;return(0,u.Z)(function*(){const a=yield i.getResources(e,t),l=(0,D.getDataGridItemsAttributeName)(e),s=i._getEntitySchemaName(l,t);for(const d of n)yield i._setColumnModelProperties(d,t,s,l),i.setColumnCaptionResources(d,a,e);return{dataSourceSchemaName:s,columns:n}})()}_setColumnModelProperties(e,t,n,i){var a=this;return(0,u.Z)(function*(){if(!i||!n||!e.code)return;const l=`${i}.${e.code}`,s=t.getBoundDataSchemaAttributeByAttributePath(l);if(!s?.path||s.attributeType!==c.DataSchemaAttributeType.AggregationAttribute)return;const d=yield a.getEntitySchemaNameByPath(n,s.path);e.path=s.path,e.aggregationConfig=s.aggregationConfig||e.aggregationConfig,e.referenceSchemaName=d||e.referenceSchemaName})()}_processColumnOriginalCaption(e,t){const n=t.path,i=n?.startsWith("[")?t.referenceSchemaName:e;return!n||!i||!t.aggregationConfig?(0,m.of)(t):this._entitySchemaProvider.getSchemaByName(i).pipe((0,C.switchMap)(a=>this._entitySchemaService.getEntitySchemaColumnsInformationByPath(a.uId,n," > ")),(0,C.map)(a=>{let l=a.columnCaptionPath;const s=t.aggregationConfig?.aggregationFunction;return s&&(l=this._getAggregationColumnOriginalCaption(l,t.dataValueType,s)),t.originalCaption=l,t}))}_getAggregationColumnOriginalCaption(e,t,n){const i=(0,Se.getAllowedAggregationFunctionsByDataValueType)(t);i.push({func:c.AggregationFunction.Count,captionResource:"Count"});const a=i.find(s=>s.func===n)?.captionResource||"",l=this._getAggregationFunctionCaption(a);return n===c.AggregationFunction.TopOne?this._translateService.currentLang===f.DEFAULT_CULTURE_NAME?`${e} (the ${l.toLowerCase()})`:`${e} (${l.toLowerCase()})`:n===c.AggregationFunction.Count?`${e.split(" > ").slice(0,-1).join(" > ")} ${l}`:`${e} ${l}`}_getAggregationFunctionCaption(e){return this._translateService.instant("AggregationNames."+e)}onColumnPreparationFinished(){}handle(e,t,n){const i=n.get(y.VIEW_ELEMENT_CONFIG),a=this.schemaService.getViewConfigInfoByName(i.name).viewConfig;return n.get(y.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)).pipe((0,C.mergeMap)(d=>this.processColumns(a,d,t)),(0,C.mergeMap)(d=>{const p=(0,$.cloneDeep)(d.columns.find(h=>h.id===e));return this._processColumnOriginalCaption(d.dataSourceSchemaName,p).pipe((0,m.tap)(()=>this.onColumnPreparationFinished()),(0,C.mergeMap)(h=>this._columnEditService.edit(h,n).pipe((0,C.map)(ne=>this._replaceColumn(ne,e,d.columns)))))}))}}P.\u0275fac=function(e){return new(e||P)(o.\u0275\u0275inject(o.Injector))},P.\u0275prov=o.\u0275\u0275defineInjectable({token:P,factory:P.\u0275fac});var Te=g(18369),le=g(33177),Ve=g(96923),Ie=g(54134);const ie=new o.InjectionToken("A cell view config factory"),fe=new o.InjectionToken("A factory of editing cell view config creators"),pe=new o.InjectionToken("A cell view config factory");class J{constructor(e,t,n,i){this.structureExplorer=e,this.schemaService=t,this.cellViewConfigCreatorFactory=n,this.translateService=i}_openStructureExplorer(e){return this.structureExplorer.show({providers:[e],enableMultiSelection:!0,collectDrillDownItems:!0})}_getColumnCaptionResourceMacros(e,t){const n=t.split(".").join("");return`#ResourceString(${e}_${n})#`}_getStructureExplorerDataProviderConfig(e,t){const n=e.getBoundDataSourceNameByAttributePath(t);return{name:Ve.DATA_SOURCE_STRUCTURE_EXPLORER_DATA_PROVIDER_NAME,navigateOnlyThroughDataSource:n,options:{useBackwards:!0}}}_modifyAggregationColumnCode(e,t){return e+t+Ie.Guid.create().toString().slice(0,8)}createColumnDefinition(e){const{structureExplorerItem:t,dataSourceName:n}=e,i=this.getColumnName(t.columnPath),a=t.data?.item?.aggregationFunction;let l=`${n}_${i}`;a&&(l=this._modifyAggregationColumnCode(l,a));const s=t.data.dataValueType,d=a?this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction):this._getColumnCaptionResourceMacros(n,i),p=t.data.isMasked,h={id:(0,c.generateGuid)(),code:l,path:t.columnPath,caption:d,dataValueType:s,referenceSchemaName:t.data?.item?.referenceSchemaName,isMasked:p};return a&&(h.aggregationConfig={aggregationFunction:t.data?.item?.aggregationFunction},a===c.AggregationFunction.TopOne&&(h.aggregationConfig.sortByColumn="Id",h.aggregationConfig.sortByDirection=c.OrderDirection.Asc),h.captionResources=new f.LocalizableStringArray,h.captionResources.setValueLocalizableString(this.translateService.currentLang,this.getAggregationColumnCaption(t.caption,t.data.item.aggregationFunctionCaption,t.data.item.aggregationFunction)),h.captionResourcesChanged=!0),{...h}}getItemsAttributeName(e){const t=e.get(y.VIEW_ELEMENT_CONFIG),n=this.schemaService.getViewConfigInfoByName(t.name).viewConfig;return re(n)}getAggregationColumnCaption(e,t,n){return n===c.AggregationFunction.TopOne?this.translateService.currentLang===f.DEFAULT_CULTURE_NAME?`${e} (the ${t.toLowerCase()})`:`${e} (${t.toLowerCase()})`:`${e} ${t}`}getColumnName(e){return(0,f.removeSpecialSymbols)(e)}selectColumns(e){const n=e.get(y.BINDING_CONTEXT).viewModel$.pipe((0,C.take)(1)),i=this.getItemsAttributeName(e);if(!i)return(0,m.of)([]);const a=n.pipe((0,C.map)(s=>s?.getBoundDataSourceNameByAttributePath(i))),l=n.pipe((0,C.map)(s=>this._getStructureExplorerDataProviderConfig(s,i)),(0,C.switchMap)(s=>this._openStructureExplorer(s)));return(0,m.forkJoin)([l,a]).pipe((0,C.map)(([s,d])=>(s??[]).filter(p=>p.id!==d).map(p=>this.createColumnDefinition({structureExplorerItem:p,dataSourceName:d}))))}}J.\u0275fac=function(e){return new(e||J)(o.\u0275\u0275inject(Te.StructureExplorerService),o.\u0275\u0275inject(X.SchemaService),o.\u0275\u0275inject(ie),o.\u0275\u0275inject(ge.TranslateService))},J.\u0275prov=o.\u0275\u0275defineInjectable({token:J,factory:J.\u0275fac});class E{constructor(){this.type=""}getDisplayValue(e){const{column:t,itemsAttributeName:n}=e??{};return`${n}.${t?.code}`}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{column:n}=e??{};return{column:{...n},value:t.getDisplayValue(e),type:t.type}})()}}class B extends E{constructor(){super(...arguments),this.type="crt.TableTextCell"}}B.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(B)))(t||B)}}(),B.\u0275prov=o.\u0275\u0275defineInjectable({token:B,factory:B.\u0275fac,providedIn:"root"});class j extends E{constructor(){super(...arguments),this.type="crt.TableDateTimeCell"}}j.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(j)))(t||j)}}(),j.\u0275prov=o.\u0275\u0275defineInjectable({token:j,factory:j.\u0275fac,providedIn:"root"});class k extends E{constructor(){super(...arguments),this.type="crt.TableNumericCell"}}k.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(k)))(t||k)}}(),k.\u0275prov=o.\u0275\u0275defineInjectable({token:k,factory:k.\u0275fac,providedIn:"root"});var te=g(24709);class U extends E{constructor(){super(),this.type="crt.Link"}hasSectionEditPage(e){var t=this;return(0,u.Z)(function*(){const n=yield t.getReferenceSchemaName(e),i={type:"crt.7XRequest",action:"HasEntityEditPage",$context:e.context,payload:{entityName:n}};return yield c.HandlerChainService.instance.process(i)})()}getDefaultViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e);return i.type="crt.TableTextCell",i})()}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){return(yield t.hasSectionEditPage(e))?t.getLinkViewElementConfig(e):t.getDefaultViewElementConfig(e)})()}}U.\u0275fac=function(e){return new(e||U)},U.\u0275prov=o.\u0275\u0275defineInjectable({token:U,factory:U.\u0275fac});class W extends U{constructor(){super()}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.primaryAttributeName??"";return(yield(0,te.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,primaryAttributeName:i,column:a}=e,l=t.getDisplayValue(e);return{column:a,caption:l,type:t.type,href:`${n}.${i} | crt.ToRecordLinkAsync : '${i}'`,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{itemsAttributeName:n.slice(1),recordId:`${n}.${i}`}}}})()}}W.\u0275fac=function(e){return new(e||W)},W.\u0275prov=o.\u0275\u0275defineInjectable({token:W,factory:W.\u0275fac,providedIn:"root"});var ae=g(41307);class H extends U{constructor(e,t,n){super(),this._featureService=e,this._entitySchemaRepository=t,this._dcmSchemaManagerService=n,this._colorizedSchemasMap=new Map,this.type="crt.Link"}_isColumnColorized(e){var t=this;return(0,u.Z)(function*(){const n=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridColoredCell")),i=yield t.getReferenceSchemaName(e);if(!i||n)return Promise.resolve(!1);const a=t._colorizedSchemasMap.get(i);return a!==void 0?a:(0,m.lastValueFrom)(t._entitySchemaRepository.getSchemaByName(i).pipe((0,m.map)(l=>{const s=!!l.getPrimaryColorColumn();return t._colorizedSchemasMap.set(i,s),s}),(0,m.catchError)(()=>(0,m.of)(!1))))})()}_decorateConfigWithColorization(e,t){const n=super.getDisplayValue(t);e.type="crt.TableColoredCell",e.displayValue=n}_isStageColumn(e){var t=this;return(0,u.Z)(function*(){const n=yield(0,m.lastValueFrom)(t._featureService.getFeatureState("DisableDataGridProgressBarStageCell"));if(!e.dataGridSchemaName||n)return Promise.resolve(!1);const i=yield(0,m.firstValueFrom)(t._entitySchemaRepository.getSchemaByName(e.dataGridSchemaName)),a=(yield(0,m.firstValueFrom)(t._dcmSchemaManagerService.getDcmSchemaDataCollection())).find(s=>s.entitySchemaUId===i.uId);if(!a)return Promise.resolve(!1);const l=i.columns?.find(s=>s.uId===a.stageColumnUId)?.name;return l?e.column.code.split("_").pop()===l:Promise.resolve(!1)})()}_decorateConfigWithSlider(e,t){const n=`${t.dataGridName}_DCMData`;e.type="crt.TableSliderCell";const i=t.column?.code??"",l=`${`${t.itemsAttributeName}.${i}`} | crt.ToEntityStageDataTableSliderConverterAsync:$${n}`;e.percentage=`${l} | crt.ToObjectProp : 'value'`,e.color=`${l} | crt.ToObjectProp : 'color'`,e.value=this.getDisplayValue(t)}getDisplayValue(e){return`${super.getDisplayValue(e)} | crt.ToObjectProp : 'displayValue'`}getReferenceSchemaName(e){return(0,u.Z)(function*(){const t=e?.column.code??"";return(yield(0,te.getEntitySchemaAttribute)(e.context,e.itemsAttributeName.substring(1)+"."+t))?.referenceSchemaName})()}getDefaultViewElementConfig(e){var t=()=>super.getDefaultViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e),a=yield n._isColumnColorized(e);return(yield n._isStageColumn(e))?n._decorateConfigWithSlider(i,e):a&&n._decorateConfigWithColorization(i,e),i})()}getLinkViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,column:i}=e,a=t.getDisplayValue(e),l=yield t.getReferenceSchemaName(e),s=i?.code??"",d=`${n}.${s} | crt.ToObjectProp : 'value' | crt.ToRecordLinkAsync : '${s}'`,p={type:"crt.Link",column:{...i},caption:a,href:d,mode:"preventDefault",clicked:{request:"crt.UpdateRecordRequest",params:{entityName:l,recordId:`${n}.${s} | crt.ToObjectProp : "value"`}}},h=yield t._isColumnColorized(e);return(yield t._isStageColumn(e))?t._decorateConfigWithSlider(p,e):h&&t._decorateConfigWithColorization(p,e),p})()}}H.\u0275fac=function(e){return new(e||H)(o.\u0275\u0275inject(ae.FeatureService),o.\u0275\u0275inject(f.EntitySchemaRepository),o.\u0275\u0275inject(ae.DcmSchemaManagerService))},H.\u0275prov=o.\u0275\u0275defineInjectable({token:H,factory:H.\u0275fac,providedIn:"root"});class Z extends E{constructor(e){super(),this._defaultFeatures=e,this.type="crt.TableBooleanCell"}_getEditingModeDisabledExpression(e){if((0,X.isBindingExpression)(e))return`${e} | crt.PickDataGridFeatureValue : 'editable.enable' | crt.InvertBooleanValue`;const t=(0,D.fullInDataTableEditingFeatures)(e?.editable,!0);return!(0,D.fullInDataTableEditingFeatures)(this._defaultFeatures?.editable,!1).enable||!t.enable}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e),a=n.getDisplayValue(e),l=e.column.readonly===!0,s=n._getEditingModeDisabledExpression(e.features);return{...i,control:a,readonly:l||s,bindTo:a,readiness:`$${te.BUSINESS_RULES_ACTIVATED_SYSTEM_ATTRIBUTE_NAME}`}})()}}Z.\u0275fac=function(e){return new(e||Z)(o.\u0275\u0275inject(D.DATA_GRID_FEATURES,8))},Z.\u0275prov=o.\u0275\u0275defineInjectable({token:Z,factory:Z.\u0275fac,providedIn:"root"});class T extends E{constructor(){super(...arguments),this.type="crt.TablePhoneCell"}}T.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(T)))(t||T)}}(),T.\u0275prov=o.\u0275\u0275defineInjectable({token:T,factory:T.\u0275fac,providedIn:"root"});class V extends E{constructor(){super(...arguments),this.type="crt.TableEmailCell"}}V.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(V)))(t||V)}}(),V.\u0275prov=o.\u0275\u0275defineInjectable({token:V,factory:V.\u0275fac,providedIn:"root"});class I extends E{constructor(){super(...arguments),this.type="crt.TableFileCell"}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{itemsAttributeName:n,primaryAttributeName:i,dataSchemaName:a,column:l}=e;return{column:{...l},fileName:t.getDisplayValue(e),fileUrl:`${n}.${i} | crt.ToFileLink : '${a}'`,type:t.type}})()}}I.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(I)))(t||I)}}(),I.\u0275prov=o.\u0275\u0275defineInjectable({token:I,factory:I.\u0275fac,providedIn:"root"});class v extends E{constructor(){super(...arguments),this.type="crt.TableFileSizeCell"}}v.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(v)))(t||v)}}(),v.\u0275prov=o.\u0275\u0275defineInjectable({token:v,factory:v.\u0275fac,providedIn:"root"});class A extends E{constructor(){super(...arguments),this.type="crt.TableRichTextEditorCell"}}A.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(A)))(t||A)}}(),A.\u0275prov=o.\u0275\u0275defineInjectable({token:A,factory:A.\u0275fac,providedIn:"root"});class z extends E{constructor(){super(),this.type="crt.Link"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e),a=e.column.dataValueType===c.DataValueType.EMAIL_TEXT;return i.href=a?`${i.value} | crt.ToEmailLink`:`${i.value} | crt.LinkPrefix`,i.caption=`${i.value}`,i.mode="native",i.target=a?"_self":"_blank",i})()}}z.\u0275fac=function(e){return new(e||z)},z.\u0275prov=o.\u0275\u0275defineInjectable({token:z,factory:z.\u0275fac,providedIn:"root"});class w extends E{constructor(){super(...arguments),this.type="crt.TableDcmStageCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e),a=n.getDisplayValue(e);return{...i,value:a,bindTo:a,dcmStages:"$DcmStages"}})()}}w.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(w)))(t||w)}}(),w.\u0275prov=o.\u0275\u0275defineInjectable({token:w,factory:w.\u0275fac,providedIn:"root"});class _{constructor(){this.type=""}getColumnDataSchemaAttribute(e){const{column:t,context:n,itemsAttributeName:i}=e,a=(0,D.getDataGridItemsAttributeName)({items:i});if(!t.code||!a)return null;const l=`${a}.${t.code}`;return n.getBoundDataSchemaAttributeByAttributePath(l)}getViewElementConfig(e){var t=this;return(0,u.Z)(function*(){const{column:n,itemsAttributeName:i}=e??{};return{type:t.type,control:`${i}.${n.code}`,bindTo:`${i}.${n.code}`}})()}}class b extends _{constructor(){super(...arguments),this.type="crt.DataTableEditTextCell"}}b.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(b)))(t||b)}}(),b.\u0275prov=o.\u0275\u0275defineInjectable({token:b,factory:b.\u0275fac,providedIn:"root"});class F extends _{constructor(){super(...arguments),this.type="crt.DataTableEditNumericCell"}}F.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(F)))(t||F)}}(),F.\u0275prov=o.\u0275\u0275defineInjectable({token:F,factory:F.\u0275fac,providedIn:"root"});class N extends _{constructor(){super(...arguments),this.type="crt.DataTableEditLookupCell"}}N.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(N)))(t||N)}}(),N.\u0275prov=o.\u0275\u0275defineInjectable({token:N,factory:N.\u0275fac,providedIn:"root"});class R extends _{constructor(){super(...arguments),this._dataValueTypeToDateType=new Map([[c.DataValueType.Date,f.DateTypes.Date],[c.DataValueType.Time,f.DateTypes.Time],[c.DataValueType.DateTime,f.DateTypes.DateTime]]),this.type="crt.DataTableEditDateTimeCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const{column:i}=e??{};return{...yield t().call(n,e),dateType:n._dataValueTypeToDateType.get(i.dataValueType)??f.DateTypes.DateTime}})()}}R.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(R)))(t||R)}}(),R.\u0275prov=o.\u0275\u0275defineInjectable({token:R,factory:R.\u0275fac,providedIn:"root"});class G extends _{getViewElementConfig(e){return(0,u.Z)(function*(){return null})()}}G.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(G)))(t||G)}}(),G.\u0275prov=o.\u0275\u0275defineInjectable({token:G,factory:G.\u0275fac,providedIn:"root"});class L extends _{constructor(){super(...arguments),this.type="crt.DataTableEditPhoneCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e);if(!e?.context)return i;const a=n.getColumnDataSchemaAttribute(e);return a?{...i,displayAsPhone:a.isMasked}:i})()}}L.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(L)))(t||L)}}(),L.\u0275prov=o.\u0275\u0275defineInjectable({token:L,factory:L.\u0275fac,providedIn:"root"});class M extends _{constructor(){super(...arguments),this.type="crt.DataTableEditEmailCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){const i=yield t().call(n,e);if(!e?.context)return i;const a=n.getColumnDataSchemaAttribute(e);return a?{...i,isFormatValidated:a.isFormatValidated}:i})()}}M.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(M)))(t||M)}}(),M.\u0275prov=o.\u0275\u0275defineInjectable({token:M,factory:M.\u0275fac,providedIn:"root"});class x extends _{constructor(){super(...arguments),this.type="crt.DataTableEditWebCell"}}x.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(x)))(t||x)}}(),x.\u0275prov=o.\u0275\u0275defineInjectable({token:x,factory:x.\u0275fac,providedIn:"root"});class O extends _{constructor(){super(...arguments),this.type="crt.TableDcmStageEditingCell"}getViewElementConfig(e){var t=()=>super.getViewElementConfig,n=this;return(0,u.Z)(function*(){return{...yield t().call(n,e),column:{},dcmStages:"$DcmStages"}})()}}O.\u0275fac=function(){let r;return function(t){return(r||(r=o.\u0275\u0275getInheritedFactory(O)))(t||O)}}(),O.\u0275prov=o.\u0275\u0275defineInjectable({token:O,factory:O.\u0275fac,providedIn:"root"});const he="CheckDataGridColumnsRightsOnLoad",ve="DisableDataGridEditingMode",Ae="DisableDataGridMultipleRowsSelection",we="CanCreateDefaultGridSettings",Ee=[c.DataValueType.Guid,c.DataValueType.Text,c.DataValueType.Integer,c.DataValueType.Float,c.DataValueType.Money,c.DataValueType.DateTime,c.DataValueType.Date,c.DataValueType.Time,c.DataValueType.Lookup,c.DataValueType.Enum,c.DataValueType.Boolean,c.DataValueType.SHORT_TEXT,c.DataValueType.MEDIUM_TEXT,c.DataValueType.MAXSIZE_TEXT,c.DataValueType.LONG_TEXT,c.DataValueType.FLOAT1,c.DataValueType.FLOAT2,c.DataValueType.FLOAT3,c.DataValueType.FLOAT4,c.DataValueType.FLOAT8,c.DataValueType.PHONE_TEXT,c.DataValueType.WEB_TEXT,c.DataValueType.EMAIL_TEXT];class K{constructor(e,t,n){this._cellViewConfigCreatorFactory=e,this._rightsService=t,this._featureService=n}_getColumnName(e){return e.dataValueType===c.DataValueType.Lookup?`${e.path}Id`:e.path}_getColumnsAccessRights(e){const t=(0,$.uniq)(e.attributes.map(this._getColumnName));return this._featureService.getFeatureState(he).pipe((0,C.switchMap)(i=>i?this._requestColumnsAccessRights(e.name,t):this._allowColumnsAccessRights(t)))}_allowColumnsAccessRights(e){const t={};return e.forEach(n=>t[n]=!0),(0,m.of)(t)}_requestColumnsAccessRights(e,t){return this._rightsService.getCanEditColumns({schemaName:e,columnNames:t})}_isReadonlyColumn(e,t){const n=this._getColumnName(t),i=!te.DATA_SCHEMA_SYSTEM_COLUMNS.includes(t.path),a=t.attributeType===c.DataSchemaAttributeType.OwnAttribute,l=Ee.includes(t.dataValueType);return!(e[n]&&a&&i&&l)}_generateColumnDefinition(e,t,n){const{dataSourceName:i,dataSchema:a,itemsAttributeName:l,viewModel:s,features:d,dataGridName:p}=e,h=t.name,{primaryAttributeName:ne,primaryDisplayAttributeName:ye,name:Le}=a??{},Me=ne&&`${i}_${ne}`,xe={columnName:h,dataValueType:t.dataValueType,primaryDisplayAttributeName:ye},Oe={column:{...n,id:(0,c.generateGuid)()},context:s,itemsAttributeName:l,features:d,primaryAttributeName:Me,primaryDisplayAttributeName:ye,columnName:h,dataGridName:p,dataGridSchemaName:Le},$e=this._cellViewConfigCreatorFactory.create(xe)?.getViewElementConfig(Oe)??(0,m.of)(null);return(0,m.from)($e).pipe((0,C.map)(Pe=>({...n,cellView:Pe})))}processDataGridColumnDefinitions(e,t){const{dataSourceName:n,dataSchema:i}=e;return this._getColumnsAccessRights(i).pipe((0,C.switchMap)(a=>{const l=t.map(s=>{const d=i.attributes.find(p=>(0,f.removeSpecialSymbols)(`${n}_${p.name}`)===s.code);return d?(0,$.isUndefined)(s.readonly)?this._generateColumnDefinition(e,d,{...s,readonly:this._isReadonlyColumn(a,d)}):this._generateColumnDefinition(e,d,s):(0,m.of)(s)});return(0,m.forkJoin)(l)}))}getDataGridColumnDefinition(e,t,n){const{dataSchema:i,dataSourceName:a}=e;return this._getColumnsAccessRights(i).pipe((0,C.switchMap)(l=>{const s=`${a}_${t.name}`,d=(0,c.generateGuid)(),p={id:d,code:(0,f.removeSpecialSymbols)(s),caption:n||`#ResourceString(${d.split("-")[0]})#`,dataValueType:t.dataValueType,readonly:this._isReadonlyColumn(l,t)};return this._generateColumnDefinition(e,t,p)}))}}K.\u0275fac=function(e){return new(e||K)(o.\u0275\u0275inject(ie),o.\u0275\u0275inject(ae.RightsService),o.\u0275\u0275inject(ae.FeatureService))},K.\u0275prov=o.\u0275\u0275defineInjectable({token:K,factory:K.\u0275fac,providedIn:"root"});var be=g(29989),Fe=g.n(be);class Q extends P{constructor(e,t,n,i,a,l){super(e),this._maskService=t,this._metadataModifier=n,this._schemaPartService=i,this._entitySchemaRepository=a,this._dataGridActiveFolderDesignSettingsProvider=l}_getResourcesFromProfile(){var e=this;return(0,u.Z)(function*(){const[,t]=yield e._schemaPartService.use("USER"),n=yield t.loadResources();return{strings:(0,$.cloneDeep)(n?.localizableStrings)}})()}_getResourcesFromActiveFolderSettings(e,t){var n=this;return(0,u.Z)(function*(){const i=yield n._dataGridActiveFolderDesignSettingsProvider.get({viewConfig:e,viewModel:t,metadata:n.schemaService.schema});return{strings:(0,$.cloneDeep)(i?.resources?.localizableStrings??{})}})()}getResources(e,t){var n=this;return(0,u.Z)(function*(){const i=yield n._getResourcesFromProfile(),a=yield n._getResourcesFromActiveFolderSettings(e,t);return Fe()(i,a)})()}getEntitySchemaNameByPath(e,t){const n=t.split("."),i=this._entitySchemaRepository.findEntitySchemaByPath(e,n);return Promise.resolve(i?.name)}setColumnCaptionResources(e,t,n){const i=this._metadataModifier.revert((0,$.cloneDeep)(e)),a=(0,f.extractResourcesKey)(i.caption);!a||(e.captionResources=(0,f.toLocalizableStringsArray)(t.strings,a))}processColumns(e,t,n){return this._maskService.showBodyMask(),super.processColumns(e,t,n)}onColumnPreparationFinished(){this._maskService.hideBodyMask()}}Q.\u0275fac=function(e){return new(e||Q)(o.\u0275\u0275inject(o.Injector),o.\u0275\u0275inject(c.MaskService),o.\u0275\u0275inject(te.MetadataModifierService),o.\u0275\u0275inject(X.SchemaPartsService),o.\u0275\u0275inject(f.EntitySchemaRepository),o.\u0275\u0275inject(D.DataGridActiveFolderDesignSettingsProvider))},Q.\u0275prov=o.\u0275\u0275defineInjectable({token:Q,factory:Q.\u0275fac});class q{constructor(e){this._columnSelectionService=e}_canSelectColumns(e){if(e===null)return(0,m.of)(!1);const t={type:"crt.CanDiscardUnsavedDataRequest",$context:e},n=c.HandlerChainService.instance.process(t);return(0,m.from)(n)}_getDataGridCollection(e,t){const n=e.get(y.VIEW_ELEMENT_CONFIG),i=re(n);return i?(0,m.from)(t[i]).pipe((0,C.map)(a=>a)):(0,m.of)(null)}selectColumns(e){return e.get(y.BINDING_CONTEXT).viewModel$.pipe((0,C.switchMap)(t=>this._getDataGridCollection(e,t)),(0,C.switchMap)(t=>this._canSelectColumns(t)),(0,C.switchMap)(t=>(0,m.iif)(()=>t,this._columnSelectionService.selectColumns(e),(0,m.of)([]))),(0,C.take)(1))}}q.\u0275fac=function(e){return new(e||q)(o.\u0275\u0275inject(D.DataGridColumnSelectionService))},q.\u0275prov=o.\u0275\u0275defineInjectable({token:q,factory:q.\u0275fac});const Ne=le.FactoryProvider.create({token:ie,mappings:[{predicate:({columnName:r,primaryDisplayAttributeName:e})=>Boolean(r)&&r===e,injectable:W},{predicate:({dataValueType:r})=>r===c.DataValueType.Lookup,injectable:H},{predicate:({dataValueType:r})=>r===c.DataValueType.Boolean,injectable:Z},{predicate:({dataValueType:r})=>r===c.DataValueType.PHONE_TEXT,injectable:T},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT,injectable:V},{predicate:({dataValueType:r})=>r===c.DataValueType.RICH_TEXT,injectable:A},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT||r===c.DataValueType.WEB_TEXT,injectable:z},{predicate:({dataValueType:r,columnName:e})=>r===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:w}]}),Re=le.FactoryProvider.create({token:fe,mappings:[{predicate:({dataValueType:r})=>f.DATE_TIME_DATA_VALUE_TYPES.includes(r),injectable:R},{predicate:({dataValueType:r})=>f.NUMERIC_DATA_VALUE_TYPES.includes(r),injectable:F},{predicate:({dataValueType:r})=>r===c.DataValueType.Lookup,injectable:N},{predicate:({dataValueType:r})=>r===c.DataValueType.Boolean,injectable:G},{predicate:({dataValueType:r})=>r===c.DataValueType.PHONE_TEXT,injectable:L},{predicate:({dataValueType:r})=>r===c.DataValueType.EMAIL_TEXT,injectable:M},{predicate:({dataValueType:r})=>r===c.DataValueType.WEB_TEXT,injectable:x},{predicate:({dataValueType:r,columnName:e})=>r===c.DataValueType.Guid&&e.includes("DcmStageValue"),injectable:O}],default:{injectable:b}}),Ge=le.FactoryProvider.create({token:pe,mappings:[{predicate:({columnName:r,primaryDisplayAttributeName:e})=>r&&r===e,injectable:I},{predicate:({columnName:r})=>r&&r==="Size",injectable:v}]});var ee=g(74742);let se=class extends c.BaseRequest{constructor(){super(...arguments),this.type="crt.DataGridCancelItemsChangesRequest"}};se=(0,ee.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridCancelItemsChangesRequest"})],se);let oe=class extends c.BaseRequestHandler{constructor(e){super(),this._schemaService=e}_canCancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const{$context:n,itemsAttributeName:i,changedItems:a}=e;if(!n||!i)return!1;if(a&&a.length>0)return!0;const l=yield n[i],s={type:"crt.CanDiscardUnsavedDataRequest",$context:l};return yield t.handlerChain.process(s)})()}_cancelItemsChanges(e){var t=this;return(0,u.Z)(function*(){const n={type:"crt.CancelRecordsChangesRequest",$context:e.$context,recordIds:e.changedItems,itemsAttributeName:e.itemsAttributeName};return yield t.handlerChain.process(n)})()}_getDataGridViewConfigs(e){return this._schemaService.getViewConfigInfoByFilter(t=>{const{type:n,items:i}=t;return n==="crt.DataGrid"&&i===`$${e}`}).map(t=>t.viewConfig)}_cleanupSelectionState(e,t){const n=this._getDataGridViewConfigs(e).map(i=>i?._selectionOptions?.attribute||(0,D.createDataGridSelectionStateAttributeName)(i)).map(i=>this.handlerChain.process({type:"crt.ChangeViewModelAttributeValueRequest",$context:t,attributeName:i,attributeValue:null}));return Promise.all(n)}handle(e){var t=this;return(0,u.Z)(function*(){return e?(yield t._canCancelItemsChanges(e))?t._cancelItemsChanges(e):(yield t._cleanupSelectionState(e.itemsAttributeName,e.$context),!1):!1})()}};oe=(0,ee.__decorate)([(0,c.CrtRequestHandler)({type:"crt.DataGridCancelItemsChangesHandler",requestType:"crt.DataGridCancelItemsChangesRequest"}),(0,ee.__metadata)("design:paramtypes",[X.SchemaService])],oe);let ue=class extends c.BaseRequest{};ue=(0,ee.__decorate)([(0,c.CrtRequest)({type:"crt.DataGridRowDoubleClickRequest"})],ue);let ce=class extends c.BaseRequestHandler{_isClickByNewRecord(e){return(0,u.Z)(function*(){const{itemsAttributeName:t,rowId:n}=e;return!t||!n?!1:(yield(yield e.$context[t])?.findByPrimaryAttribute(n))?.getPrimaryModelMode()===f.ModelMode.Create})()}_createUpdateRecordRequest(e){return{type:"crt.UpdateRecordRequest",$context:e.$context,recordId:e.rowId,itemsAttributeName:e.itemsAttributeName}}handle(e){var t=this;return(0,u.Z)(function*(){return(yield t._isClickByNewRecord(e))?Promise.resolve():t.handlerChain.process(t._createUpdateRecordRequest(e))})()}};ce=(0,ee.__decorate)([(0,c.CrtRequestHandler)({requestType:"crt.DataGridRowDoubleClickRequest",type:"crt.DataGridRowDoubleClickHandler"})],ce);var _e=g(31134);let S=class{};S.\u0275fac=function(e){return new(e||S)},S.\u0275mod=o.\u0275\u0275defineNgModule({type:S}),S.\u0275inj=o.\u0275\u0275defineInjector({imports:[_e.CommonModule]}),S=(0,ee.__decorate)([(0,c.CrtModule)({requestHandlers:[oe,ce]})],S),function(){(typeof ngJitMode>"u"||ngJitMode)&&o.\u0275\u0275setNgModuleScope(S,{imports:[_e.CommonModule]})}()}}]);
